<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OD on the GO — Conference Scratcher</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --line:#e6edf6;
      --muted:#5b6b7f;
      --text:#0b1b2b;
      --brand1:#1f86a5; /* teal */
      --brand2:#2aa3c3; /* lighter teal */
      --btn:#0b1b2b;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:24px;
    }

    .wrap{
      max-width: 1060px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 14px 34px rgba(12, 35, 66, .08);
    }

    /* Header */
    .hero{
      padding: 22px 26px;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color:#fff;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
    }
    .heroLeft{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title{
      font-family: Montserrat, Inter, system-ui, sans-serif;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 34px;
      line-height: 1.1;
      margin:0;
    }
    .sub{
      margin:0;
      opacity:.95;
      font-size: 14.5px;
      font-weight: 500;
    }

    /* Your requested logo markup target */
    .logoRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .logoBox{
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      border-radius: 10px;
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      height:46px;
      width: 92px;
      overflow:hidden;
    }
    .logoBox img{
      max-height: 34px;
      max-width: 80px;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.15));
    }

    /* Content */
    .content{
      padding: 22px 26px 0 26px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top: 8px;
    }

    label{
      display:block;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #22364a;
    }

    input{
      width:100%;
      padding: 14px 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size: 15px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color: rgba(42,163,195,.55);
      box-shadow: 0 0 0 4px rgba(42,163,195,.12);
    }

    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 14px;
      align-items:center;
    }

    .btn{
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
    }
    .btnPrimary{
      background: #7a7a7a;
      color:#fff;
      border-color:#7a7a7a;
    }
    .btnDark{
      background: var(--btn);
      color:#fff;
      border-color: var(--btn);
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .savedBox{
      margin-top: 14px;
      padding: 14px 14px;
      background: #eef6ff;
      border: 1px solid #d6e9ff;
      border-radius: 12px;
      display:none;
    }
    .savedTitle{
      font-weight: 900;
      margin:0 0 4px 0;
      color:#114c8b;
    }
    .savedText{
      margin:0;
      color:#24405d;
      font-size: 14px;
      font-weight: 600;
    }

    /* Scratch card */
    .scratchWrap{
      margin-top: 18px;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background: #fff;
    }
    .scratchHeader{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid var(--line);
      font-weight: 900;
    }
    .inv{
      font-weight: 700;
      color: var(--muted);
      font-size: 13px;
    }

    .scratchStage{
      position: relative;
      background: linear-gradient(135deg, rgba(42,163,195,.10), rgba(31,134,165,.08), rgba(42,163,195,.06));
      height: 280px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px;
    }

    .prizeUnder{
      text-align:center;
      padding: 18px;
      width: 100%;
      max-width: 720px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.72);
      font-weight: 900;
      letter-spacing: .3px;
    }

    .prizeTitle{
      font-family: Montserrat, Inter, system-ui, sans-serif;
      font-weight: 900;
      font-size: 40px;
      line-height: 1.05;
      margin: 12px 0 10px 0;
      letter-spacing: .2px;
    }

    .codeLine{
      font-size: 16px;
      font-weight: 800;
      margin: 0;
      color:#172b3a;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      touch-action: none; /* important on iPad */
    }

    /* Bottom admin row */
    .adminBar{
      padding: 16px 26px 22px 26px;
      display:flex;
      justify-content:flex-end;
      gap:12px;
      border-top: 1px dashed var(--line);
      margin-top: 16px;
    }
    .noteSmall{
      font-size:12px;
      color: var(--muted);
      font-weight:600;
      margin: 0 26px 18px 26px;
      display:none; /* you wanted tips hidden */
    }

    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
      .logoRow{ justify-content:flex-start; }
      .hero{ flex-direction:column; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="heroLeft">
        <h1 class="title">Scratch to Win</h1>
        <p class="sub">AOA Optometry’s Meeting • Phoenix 2026</p>
      </div>

      <!-- ✅ Your requested logo code -->
      <div class="logoRow">
        <div class="logoBox"><img src="assets/aoa-logo.jpeg" alt="AOA Logo"></div>
        <div class="logoBox"><img src="assets/odgo-logo.jpeg" alt="OD on the GO Logo"></div>
      </div>
    </div>

    <div class="content">
      <div class="grid">
        <div>
          <label for="fullName">Full Name</label>
          <input id="fullName" type="text" placeholder="Full name" autocomplete="name">
        </div>
        <div>
          <label for="email">Email Address</label>
          <input id="email" type="email" placeholder="name@email.com" autocomplete="email">
        </div>
      </div>

      <div class="actions">
        <button id="saveBtn" class="btn btnPrimary">Save — scratch below!</button>
        <button id="nextBtn" class="btn" disabled>Next Student</button>
      </div>

      <div id="savedBox" class="savedBox">
        <p class="savedTitle">Saved ✅</p>
        <p id="savedText" class="savedText"></p>
      </div>

      <div class="scratchWrap">
        <div class="scratchHeader">
          <div>Scratch to reveal your prize</div>
          <div class="inv">Inventory remaining: <span id="invCount">—</span></div>
        </div>

        <div class="scratchStage" id="scratchStage">
          <div class="prizeUnder">
            <div class="pill">YOUR PRIZE</div>
            <div id="prizeText" class="prizeTitle">—</div>
            <p id="codeText" class="codeLine">Code: —</p>
            <div class="hint">Scratch the gray card to reveal your discount.</div>
          </div>

          <canvas id="scratchCanvas" aria-label="Scratch area"></canvas>
        </div>
      </div>
    </div>

    <!-- Admin buttons moved to bottom (so they don't get tapped accidentally) -->
    <div class="adminBar">
      <button id="exportBtn" class="btn">Export CSV</button>
      <button id="resetBtn" class="btn">Reset Device Data</button>
    </div>

    <!-- Hidden tip text (you asked to hide) -->
    <p class="noteSmall">Tip: Each device keeps its own leads + inventory (until you connect a backend).</p>
  </div>

  <script>
    /***********************
     * Storage keys
     ***********************/
    const LS_LEADS = "odgo_leads_v3";
    const LS_INVENTORY = "odgo_inventory_v3";

    /***********************
     * Inventory (your spec)
     * 2 free Part 1, 2 free Part 2, 2 free Part 3 (unique codes)
     * 50 x $50 off any course (same code)
     * 400 x 20% off any course (same code)
     ***********************/
    const DEFAULT_CODES = {
      FREE_P1_1: "FREEP1A",
      FREE_P1_2: "FREEP1B",
      FREE_P2_1: "FREEP2A",
      FREE_P2_2: "FREEP2B",
      FREE_P3_1: "FREEP3A",
      FREE_P3_2: "FREEP3B",
      OFF50: "CONF50",
      OFF20: "ODGO20"
    };

    function buildDefaultInventory(){
      const inv = [];

      // Grand prizes (unique)
      inv.push({ prize: "FREE PART 1 COURSE", code: DEFAULT_CODES.FREE_P1_1 });
      inv.push({ prize: "FREE PART 1 COURSE", code: DEFAULT_CODES.FREE_P1_2 });
      inv.push({ prize: "FREE PART 2 COURSE", code: DEFAULT_CODES.FREE_P2_1 });
      inv.push({ prize: "FREE PART 2 COURSE", code: DEFAULT_CODES.FREE_P2_2 });
      inv.push({ prize: "FREE PART 3 COURSE", code: DEFAULT_CODES.FREE_P3_1 });
      inv.push({ prize: "FREE PART 3 COURSE", code: DEFAULT_CODES.FREE_P3_2 });

      // 50 x $50 off (same code)
      for (let i=0;i<50;i++){
        inv.push({ prize: "$50 OFF ANY COURSE", code: DEFAULT_CODES.OFF50 });
      }

      // 400 x 20% off (same code)
      for (let i=0;i<400;i++){
        inv.push({ prize: "20% OFF ANY COURSE", code: DEFAULT_CODES.OFF20 });
      }

      // Shuffle so it’s truly random
      return shuffle(inv);
    }

    function shuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    /***********************
     * DOM
     ***********************/
    const fullNameEl = document.getElementById("fullName");
    const emailEl = document.getElementById("email");
    const saveBtn = document.getElementById("saveBtn");
    const nextBtn = document.getElementById("nextBtn");
    const exportBtn = document.getElementById("exportBtn");
    const resetBtn = document.getElementById("resetBtn");

    const savedBox = document.getElementById("savedBox");
    const savedText = document.getElementById("savedText");

    const invCountEl = document.getElementById("invCount");
    const prizeTextEl = document.getElementById("prizeText");
    const codeTextEl = document.getElementById("codeText");

    const canvas = document.getElementById("scratchCanvas");
    const stage = document.getElementById("scratchStage");
    const ctx = canvas.getContext("2d");

    /***********************
     * State
     ***********************/
    let inventory = [];
    let currentPrize = null;
    let currentLeadIndex = null;

    let scratching = false;

    /***********************
     * Helpers
     ***********************/
    function validEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function loadLeads(){
      try { return JSON.parse(localStorage.getItem(LS_LEADS) || "[]"); }
      catch { return []; }
    }
    function saveLeads(leads){
      localStorage.setItem(LS_LEADS, JSON.stringify(leads));
    }

    function loadInventory(){
      try {
        const raw = localStorage.getItem(LS_INVENTORY);
        if (!raw) return null;
        const inv = JSON.parse(raw);
        if (!Array.isArray(inv)) return null;
        return inv;
      } catch {
        return null;
      }
    }
    function saveInventory(inv){
      localStorage.setItem(LS_INVENTORY, JSON.stringify(inv));
    }

    function refreshInventoryCount(){
      invCountEl.textContent = String(inventory.length);
    }

    function lockInputs(locked){
      fullNameEl.disabled = locked;
      emailEl.disabled = locked;
    }

    function setPrizeUI(prizeObj){
      if (!prizeObj){
        prizeTextEl.textContent = "—";
        codeTextEl.textContent = "Code: —";
        return;
      }
      prizeTextEl.textContent = prizeObj.prize;
      codeTextEl.textContent = `Code: ${prizeObj.code}`;
    }

    /***********************
     * Scratch layer
     ***********************/
    function resizeCanvas(){
      const r = stage.getBoundingClientRect();
      canvas.width = Math.round(r.width * devicePixelRatio);
      canvas.height = Math.round(r.height * devicePixelRatio);
      canvas.style.width = r.width + "px";
      canvas.style.height = r.height + "px";
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(devicePixelRatio, devicePixelRatio);
      drawCover();
    }

    function drawCover(){
      const r = stage.getBoundingClientRect();
      ctx.globalCompositeOperation = "source-over";
      ctx.clearRect(0,0,r.width,r.height);

      // Gray cover
      ctx.fillStyle = "#bdbdbd";
      ctx.fillRect(0,0,r.width,r.height);

      // Center text
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.font = "800 34px Montserrat, Inter, system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("SCRATCH HERE", r.width/2, r.height/2);
    }

    function scratchDot(x,y){
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(x,y,28,0,Math.PI*2);
      ctx.fill();
    }

    function getPos(evt){
      const rect = canvas.getBoundingClientRect();
      if (evt.touches && evt.touches.length){
        const t = evt.touches[0];
        return { x: t.clientX - rect.left, y: t.clientY - rect.top };
      }
      return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    }

    function canScratch(){
      // Must have a saved lead + a prize assigned
      return currentLeadIndex !== null && !!currentPrize;
    }

    // ✅ Key fix: enable Next Student on FIRST scratch stroke (no % threshold)
    function enableNextStudentAfterFirstScratch(){
      if (!nextBtn.disabled) return;
      nextBtn.disabled = false;
    }

    canvas.addEventListener("mousedown", (e)=>{
      if (!canScratch()) return;
      scratching = true;
      enableNextStudentAfterFirstScratch();
      const p = getPos(e);
      scratchDot(p.x,p.y);
    });

    window.addEventListener("mousemove", (e)=>{
      if (!scratching) return;
      const p = getPos(e);
      scratchDot(p.x,p.y);
    });

    window.addEventListener("mouseup", ()=>{
      scratching = false;
    });

    canvas.addEventListener("touchstart", (e)=>{
      if (!canScratch()) return;
      scratching = true;
      enableNextStudentAfterFirstScratch();
      const p = getPos(e);
      scratchDot(p.x,p.y);
      e.preventDefault();
    }, { passive:false });

    canvas.addEventListener("touchmove", (e)=>{
      if (!scratching) return;
      const p = getPos(e);
      scratchDot(p.x,p.y);
      e.preventDefault();
    }, { passive:false });

    canvas.addEventListener("touchend", ()=>{
      scratching = false;
    });

    /***********************
     * Prize selection (truly random)
     ***********************/
    function pickPrizeFromInventory(){
      if (!inventory.length) return null;
      // inventory already shuffled, but we can still pick random index:
      const idx = Math.floor(Math.random() * inventory.length);
      const picked = inventory.splice(idx, 1)[0];
      saveInventory(inventory);
      refreshInventoryCount();
      return picked;
    }

    /***********************
     * Actions
     ***********************/
    function saveLead(){
      const name = (fullNameEl.value || "").trim();
      const email = (emailEl.value || "").trim();

      if (!name) { alert("Please enter a full name."); return; }
      if (!validEmail(email)) { alert("Please enter a valid email."); return; }
      if (inventory.length === 0) { alert("Inventory is empty. Reset device data to reload."); return; }

      // Assign prize NOW (and show it under scratch layer)
      nextBtn.disabled = true;
      currentPrize = pickPrizeFromInventory();
      setPrizeUI(currentPrize);
      drawCover();

      // Save lead ONCE (with prize+code immediately)
      const leads = loadLeads();
      const newEntry = {
        name,
        email,
        prize: currentPrize?.prize || "",
        code: currentPrize?.code || "",
        timestamp: new Date().toISOString()
      };
      leads.push(newEntry);
      saveLeads(leads);
      currentLeadIndex = leads.length - 1;

      // Lock inputs, show saved box
      lockInputs(true);
      saveBtn.textContent = "Saved — scratch below!";
      savedBox.style.display = "block";
      savedText.textContent = `${name} — ${email} (saved). Now scratch below to reveal your prize.`;
    }

    function nextStudent(){
      // Reset form + scratch surface for next person
      fullNameEl.value = "";
      emailEl.value = "";
      lockInputs(false);

      savedBox.style.display = "none";
      saveBtn.textContent = "Save — scratch below!";

      currentPrize = null;
      currentLeadIndex = null;

      setPrizeUI(null);
      drawCover();
      nextBtn.disabled = true;
    }

    function exportCSV(){
      const leads = loadLeads();
      if (!leads.length){
        alert("No leads yet.");
        return;
      }

      const header = ["Name","Email","Prize","Code","Timestamp"];
      const rows = leads.map(l => [
        l.name || "",
        l.email || "",
        l.prize || "",
        l.code || "",
        l.timestamp || ""
      ]);

      const csv = [header, ...rows]
        .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "odgo_conference_leads.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    function resetDeviceData(){
      if (!confirm("Reset this device’s leads + inventory?")) return;
      localStorage.removeItem(LS_LEADS);
      localStorage.removeItem(LS_INVENTORY);
      init();
      nextStudent();
      alert("Device data reset.");
    }

    /***********************
     * Init
     ***********************/
    function init(){
      // inventory
      const savedInv = loadInventory();
      if (savedInv && savedInv.length){
        inventory = savedInv;
      } else {
        inventory = buildDefaultInventory();
        saveInventory(inventory);
      }
      refreshInventoryCount();

      // initial UI
      setPrizeUI(null);
      savedBox.style.display = "none";
      nextBtn.disabled = true;

      // canvas sizing
      resizeCanvas();
    }

    saveBtn.addEventListener("click", saveLead);
    nextBtn.addEventListener("click", nextStudent);
    exportBtn.addEventListener("click", exportCSV);
    resetBtn.addEventListener("click", resetDeviceData);

    window.addEventListener("resize", resizeCanvas);

    init();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OD on the GO ‚Äî Conference Scratcher</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --line:#e8e8ee;
      --btn:#111;
      --btnText:#fff;
      --soft:#f1f6ff;
      --softLine:#cfe2ff;
    }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 26px auto;
      padding: 0 14px;
      text-align:center;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 22px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.06);
    }
    h1{
      margin: 0 0 6px;
      font-size: 30px;
    }
    .subtitle{
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 13px;
    }

    /* Lead row */
    .leadRow{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      max-width: 760px;
      margin: 0 auto 12px;
      text-align:left;
    }
    .field label{
      display:block;
      font-weight: 900;
      font-size: 13px;
      margin: 0 0 8px;
    }
    .field input{
      width:100%;
      box-sizing: border-box;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      font-size: 16px;
      outline: none;
    }
    .field input:disabled{
      background:#fafafa;
      color:#999;
    }

    .btnRow{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap: wrap;
      margin: 12px 0 14px;
    }
    .btn{
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 900;
      cursor: pointer;
      font-size: 15px;
    }
    .btn.primary{
      background: var(--btn);
      color: var(--btnText);
      min-width: 210px;
    }
    .btn.ghost{
      background:#fff;
      color:#111;
      border:1px solid var(--line);
      min-width: 160px;
    }
    .btn:disabled{
      opacity: .45;
      cursor:not-allowed;
    }

    .savedBanner{
      display:none;
      max-width: 760px;
      margin: 0 auto 16px;
      text-align:left;
      padding: 12px 14px;
      background: var(--soft);
      border: 1px solid var(--softLine);
      border-radius: 14px;
      font-size: 14px;
    }
    .savedBanner .title{
      font-weight: 900;
      margin-bottom: 4px;
    }

    /* Prize area */
    .prizeWrap{
      max-width: 820px;
      margin: 0 auto;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
    }

    .prizeTop{
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      margin-bottom: 10px;
    }
    .prizeTop .hint{
      font-size: 12px;
      color: var(--muted);
    }

    .prizeCard{
      position: relative;
      width: 100%;
      max-width: 820px;
      margin: 0 auto;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--line);
      background: #fff;
      height: 320px;
    }

    /* Underlay content */
    .underlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 18px;
      text-align:center;
    }
    .underlay .emoji{
      font-size: 30px;
      line-height: 1;
    }
    .underlay .label{
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    .underlay .code{
      font-size: 15px;
      color:#333;
    }
    .underlay .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Hide prize until revealed */
    .hiddenPrize{
      filter: blur(14px);
      opacity: .18;
      transform: scale(0.99);
      user-select:none;
    }

    /* Scratch canvas */
    canvas#scratchCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      touch-action: none;
      cursor: crosshair;
    }

    .footNote{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 720px){
      .leadRow{ grid-template-columns: 1fr; }
      .prizeCard{ height: 280px; }
      .underlay .label{ font-size: 24px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üéâ Scratch to Win</h1>
      <div class="subtitle">
        Enter your info ‚Üí scratch to reveal your discount.
        (Offline demo: leads + prizes stored on this device, export CSV.)
      </div>

      <div class="leadRow">
        <div class="field">
          <label for="fullName">Full Name</label>
          <input id="fullName" type="text" placeholder="Full name" autocomplete="name">
        </div>
        <div class="field">
          <label for="email">Email Address</label>
          <input id="email" type="email" placeholder="name@email.com" autocomplete="email">
        </div>
      </div>

      <div class="btnRow">
        <button id="saveBtn" class="btn primary" type="button">Save ‚Äî scratch below!</button>
        <button id="nextBtn" class="btn ghost" type="button" disabled>Next Student</button>
        <button id="exportBtn" class="btn primary" type="button">Export CSV</button>
        <button id="resetBtn" class="btn ghost" type="button">Reset Device Data</button>
      </div>

      <div id="savedBanner" class="savedBanner">
        <div class="title">Saved ‚úÖ</div>
        <div id="savedText">‚Äî</div>
      </div>

      <div class="prizeWrap">
        <div class="prizeTop">
          <div style="font-weight:900;">Scratch to reveal your prize</div>
          <div id="invText" class="hint">Inventory remaining: ‚Äî</div>
        </div>

        <div class="prizeCard">
          <div id="underlay" class="underlay hiddenPrize" aria-live="polite">
            <div class="emoji">üéÅ</div>
            <div style="font-size:12px; letter-spacing:1px; color:#444; font-weight:900;">YOUR PRIZE</div>
            <div id="prizeLabel" class="label">‚Äî</div>
            <div id="prizeCode" class="code">Code: ‚Äî</div>
            <div class="small">Scratch the card to reveal your discount.</div>
          </div>

          <canvas id="scratchCanvas"></canvas>
        </div>

        <div class="footNote">
          Tip: If you use multiple devices, each device keeps its own lead list + prize inventory (until we wire a backend).
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // Storage keys
  // =========================
  const KEY_LEADS = "odgo_scratcher_leads_v2";
  const KEY_INV   = "odgo_scratcher_inventory_v2";

  // =========================
  // Temporary inventory (you will replace codes later)
  // =========================
  function defaultInventory(){
    const inv = [];

    // GRAND PRIZES (unique codes)
    inv.push({type:"FREE_PART1", label:"üéì FREE Part 1 Course", code:"TEMP-P1-001"});
    inv.push({type:"FREE_PART1", label:"üéì FREE Part 1 Course", code:"TEMP-P1-002"});

    inv.push({type:"FREE_PART2", label:"üéì FREE Part 2 Course", code:"TEMP-P2-001"});
    inv.push({type:"FREE_PART2", label:"üéì FREE Part 2 Course", code:"TEMP-P2-002"});

    inv.push({type:"FREE_PART3", label:"üéì FREE Part 3 Course", code:"TEMP-P3-001"});
    inv.push({type:"FREE_PART3", label:"üéì FREE Part 3 Course", code:"TEMP-P3-002"});

    // 50 x $50 OFF (same code ok)
    for(let i=0;i<50;i++){
      inv.push({type:"50_OFF", label:"üíµ $50 OFF any course", code:"TEMP-50OFF"});
    }

    // 500 x 20% OFF (same code ok)
    for(let i=0;i<500;i++){
      inv.push({type:"20_OFF", label:"üî• 20% OFF any course", code:"TEMP-20OFF"});
    }

    return inv;
  }

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);

  function validEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
  }

  function uuid(){
    // Works on iOS Safari too
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
  }

  function loadLeads(){
    try { return JSON.parse(localStorage.getItem(KEY_LEADS) || "[]"); }
    catch { return []; }
  }
  function saveLeads(leads){
    localStorage.setItem(KEY_LEADS, JSON.stringify(leads));
  }

  function loadInv(){
    try {
      const raw = localStorage.getItem(KEY_INV);
      if (!raw) return defaultInventory();
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || parsed.length === 0) return defaultInventory();
      return parsed;
    } catch {
      return defaultInventory();
    }
  }
  function saveInv(inv){
    localStorage.setItem(KEY_INV, JSON.stringify(inv));
  }

  function invCount(){
    const inv = loadInv();
    return inv.length;
  }

  function updateInvText(){
    $("invText").textContent = "Inventory remaining: " + invCount();
  }

  // Draw a random prize from inventory (removes it so counts are enforced)
  function drawPrize(){
    const inv = loadInv();
    if (!inv.length){
      // fallback (should not happen unless depleted)
      return {type:"FALLBACK", label:"üî• 20% OFF any course", code:"TEMP-20OFF"};
    }
    const idx = Math.floor(Math.random() * inv.length);
    const prize = inv.splice(idx, 1)[0];
    saveInv(inv);
    updateInvText();
    return prize;
  }

  // =========================
  // UI state
  // =========================
  let currentLeadId = null;
  let currentPrize = null;
  let revealed = false;

  function setUnderlay(prize){
    $("prizeLabel").textContent = prize?.label || "‚Äî";
    $("prizeCode").textContent  = "Code: " + (prize?.code || "‚Äî");
  }

  function hidePrize(){
    $("underlay").classList.add("hiddenPrize");
    revealed = false;
  }

  function revealPrize(){
    $("underlay").classList.remove("hiddenPrize");
    revealed = true;
  }

  function lockForm(lock){
    $("fullName").disabled = lock;
    $("email").disabled = lock;
    $("saveBtn").disabled = lock;
    $("nextBtn").disabled = !lock; // enabled only after saving
  }

  function showSavedBanner(name, email){
    $("savedText").textContent = `${name} ‚Äî ${email} (saved). Now scratch below to reveal your prize.`;
    $("savedBanner").style.display = "block";
  }

  function hideSavedBanner(){
    $("savedBanner").style.display = "none";
  }

  // =========================
  // Scratch implementation
  // =========================
  const canvas = $("scratchCanvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  let isDown = false;

  function sizeCanvasToBox(){
    // Make canvas internal resolution match CSS size (crisp + correct scratch math)
    const box = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.round(box.width * dpr);
    canvas.height = Math.round(box.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function drawCover(){
    // Cover layer drawn in CSS-pixel coords due to transform above
    const box = canvas.getBoundingClientRect();
    const w = box.width;
    const h = box.height;

    // Paint cover
    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0, 0, w, h);

    ctx.fillStyle = "#bdbdbd";
    ctx.fillRect(0, 0, w, h);

    // Slight vignette
    const g = ctx.createRadialGradient(w/2, h/2, 10, w/2, h/2, Math.max(w,h)/1.2);
    g.addColorStop(0, "rgba(255,255,255,0.06)");
    g.addColorStop(1, "rgba(0,0,0,0.10)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // Text
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.font = "900 26px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SCRATCH HERE", w/2, h/2);

    // Erase mode
    ctx.globalCompositeOperation = "destination-out";
  }

  function getPos(evt){
    const r = canvas.getBoundingClientRect();
    const t = evt.touches ? evt.touches[0] : evt;
    return { x: t.clientX - r.left, y: t.clientY - r.top };
  }

  function scratchAt(x,y){
    ctx.beginPath();
    ctx.arc(x, y, 22, 0, Math.PI * 2);
    ctx.fill();
  }

  // performance-friendly cleared % (sample grid)
  function clearedFraction(){
    const r = canvas.getBoundingClientRect();
    const w = Math.floor(r.width);
    const h = Math.floor(r.height);
    if (w <= 0 || h <= 0) return 0;

    // Read pixels (use device pixels size)
    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

    // sample every N pixels in device space
    const step = Math.max(6, Math.floor((canvas.width + canvas.height) / 700)); // adaptive
    let total = 0;
    let cleared = 0;

    for (let y = 0; y < canvas.height; y += step){
      for (let x = 0; x < canvas.width; x += step){
        const i = (y * canvas.width + x) * 4 + 3; // alpha
        total++;
        if (data[i] === 0) cleared++;
      }
    }
    return cleared / total;
  }

  function markLeadRevealed(){
    if (!currentLeadId || !currentPrize) return;
    const leads = loadLeads();
    const idx = leads.findIndex(l => l.id === currentLeadId);
    if (idx === -1) return;

    leads[idx].revealedAt = new Date().toISOString();
    leads[idx].prizeLabel = currentPrize.label;
    leads[idx].prizeCode  = currentPrize.code;
    leads[idx].prizeType  = currentPrize.type;
    saveLeads(leads);
  }

  function checkComplete(){
    if (revealed) return;
    const pct = clearedFraction();
    if (pct >= 0.55){
      revealPrize();
      markLeadRevealed();
    }
  }

  function onDown(e){
    if (!$("nextBtn").disabled === true) { /* no-op */ }
    // only allow scratching after saving (form locked)
    if (!currentLeadId) return;
    isDown = true;
    const p = getPos(e);
    scratchAt(p.x, p.y);
    checkComplete();
    e.preventDefault?.();
  }
  function onMove(e){
    if (!isDown) return;
    if (!currentLeadId) return;
    const p = getPos(e);
    scratchAt(p.x, p.y);
    checkComplete();
    e.preventDefault?.();
  }
  function onUp(){
    isDown = false;
  }

  canvas.addEventListener("mousedown", onDown);
  canvas.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);

  canvas.addEventListener("touchstart", onDown, { passive:false });
  canvas.addEventListener("touchmove", onMove, { passive:false });
  canvas.addEventListener("touchend", onUp);

  // =========================
  // Workflow actions
  // =========================
  function startRoundAfterSave(name, email){
    // draw a prize now, but keep hidden until scratch completion
    currentPrize = drawPrize();
    setUnderlay(currentPrize);
    hidePrize();

    // store lead immediately (so you keep the email even if they walk away)
    currentLeadId = uuid();
    const leads = loadLeads();
    leads.unshift({
      id: currentLeadId,
      name,
      email,
      startedAt: new Date().toISOString(),
      revealedAt: null,
      prizeType: currentPrize.type,   // already assigned
      prizeLabel: null,               // filled after reveal
      prizeCode: null                 // filled after reveal
    });
    saveLeads(leads);

    // UI lock + banner
    lockForm(true);
    showSavedBanner(name, email);

    // reset scratch cover
    sizeCanvasToBox();
    drawCover();
  }

  function resetForNextStudent(){
    // clear state
    currentLeadId = null;
    currentPrize = null;
    revealed = false;
    isDown = false;

    // UI
    $("fullName").value = "";
    $("email").value = "";
    lockForm(false);
    hideSavedBanner();

    // reset underlay to placeholder and keep hidden
    setUnderlay({label:"‚Äî", code:"‚Äî"});
    hidePrize();

    // redraw cover
    sizeCanvasToBox();
    drawCover();
  }

  // Save lead (gate)
  $("saveBtn").addEventListener("click", () => {
    const name = ($("fullName").value || "").trim();
    const email = ($("email").value || "").trim();

    if (!name){ alert("Please enter a full name."); return; }
    if (!validEmail(email)){ alert("Please enter a valid email address."); return; }

    startRoundAfterSave(name, email);
  });

  $("nextBtn").addEventListener("click", () => {
    // allow next even if they didn't fully reveal (you still captured lead)
    resetForNextStudent();
  });

  $("exportBtn").addEventListener("click", () => {
    const leads = loadLeads();
    if (!leads.length){
      alert("No leads yet.");
      return;
    }

    const header = [
      "name","email","startedAt","revealedAt","prizeType","prizeLabel","prizeCode"
    ].join(",") + "\n";

    const rows = leads.map(l => {
      const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
      return [
        esc(l.name),
        esc(l.email),
        esc(l.startedAt),
        esc(l.revealedAt || ""),
        esc(l.prizeType || ""),
        esc(l.prizeLabel || ""),
        esc(l.prizeCode || "")
      ].join(",");
    }).join("\n");

    const blob = new Blob([header + rows], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "odgo_scratcher_leads.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("resetBtn").addEventListener("click", () => {
    if (!confirm("Reset device data? This clears saved leads AND resets prize inventory on this device.")) return;
    localStorage.removeItem(KEY_LEADS);
    localStorage.removeItem(KEY_INV);
    alert("Device data cleared.");
    // rebuild inventory fresh and reset UI
    saveInv(defaultInventory());
    updateInvText();
    resetForNextStudent();
  });

  // Keep canvas correct on resize/orientation
  window.addEventListener("resize", () => {
    sizeCanvasToBox();
    drawCover();
  });

  // =========================
  // Init
  // =========================
  // ensure inventory exists at least once
  if (!localStorage.getItem(KEY_INV)){
    saveInv(defaultInventory());
  }
  updateInvText();

  // initial placeholder underlay
  setUnderlay({label:"‚Äî", code:"‚Äî"});
  hidePrize();

  // cover
  sizeCanvasToBox();
  drawCover();

  // start unlocked
  lockForm(false);

})();
</script>
</body>
</html>

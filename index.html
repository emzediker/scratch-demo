<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OD on the GO ‚Äî Conference Scratcher</title>

  <!-- Font (swap if you want) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --line:#dbe5f2;
      --text:#0b1625;
      --muted:#5c6b7c;
      --brand1:#167aa6;   /* AOA-ish teal */
      --brand2:#2aa0bf;   /* lighter teal */
      --shadow: 0 12px 30px rgba(10, 20, 40, .08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 28px auto;
      padding: 0 16px 24px;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Header / Branding */
    .topbar{
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color: #fff;
      padding: 18px 20px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .titleBlock{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .title{
      margin:0;
      font-size: 34px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.05;
    }
    .subtitle{
      margin:0;
      font-size: 14px;
      font-weight: 600;
      opacity: .95;
      letter-spacing: .2px;
    }

    .logoRow{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:nowrap;
    }
    .logoBox{
      height: 36px;
      width: 78px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px;
    }
    .logoBox img{
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      display:block;
    }

    .content{
      padding: 18px 20px 8px;
    }

    /* Form */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 4px;
    }
    @media (max-width: 720px){
      .grid{grid-template-columns:1fr;}
      .logoRow{display:none;}
      .title{font-size: 28px;}
    }
    label{
      display:block;
      font-size: 13px;
      font-weight: 800;
      color: #20324a;
      margin-bottom: 6px;
    }
    input{
      width:100%;
      padding: 14px 14px;
      border: 1px solid #e3ebf6;
      border-radius: 12px;
      font-size: 15px;
      outline:none;
      background:#fbfdff;
    }
    input:focus{border-color:#b9d7e6; box-shadow:0 0 0 3px rgba(42,160,191,.12);}
    .actions{
      display:flex;
      gap: 12px;
      margin-top: 14px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border: 1px solid #d6e2f0;
      background:#fff;
      color:#13243b;
      font-weight: 800;
      border-radius: 12px;
      padding: 12px 16px;
      cursor:pointer;
      font-size: 14px;
    }
    button.primary{
      background:#2d2f33;
      color:#fff;
      border-color:#2d2f33;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .status{
      margin-top: 12px;
      border:1px solid #cfe7f5;
      background:#eef8ff;
      color:#0f3557;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 700;
      display:none;
    }
    .status.show{display:block;}
    .status small{
      display:block;
      margin-top: 4px;
      color:#294d6d;
      font-weight: 600;
    }

    /* Scratch area */
    .scratchWrap{
      margin-top: 16px;
      border: 1px solid #e6eef7;
      border-radius: 16px;
      overflow:hidden;
      background: #fff;
    }
    .scratchHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding: 12px 14px;
      border-bottom: 1px solid #eef3fa;
      background: #fbfdff;
      font-weight: 900;
    }
    .inv{
      font-weight: 800;
      color:#4a6077;
      font-size: 13px;
    }
    .scratchStage{
      position:relative;
      height: 240px;
      background: #fff;
    }
    @media (min-width: 860px){
      .scratchStage{height: 270px;}
    }

    /* Prize layer (under scratch) */
    .prizeLayer{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      text-align:center;
      background: radial-gradient(circle at 20% 30%, rgba(22,122,166,.10), transparent 45%),
                  radial-gradient(circle at 80% 40%, rgba(42,160,191,.12), transparent 45%),
                  radial-gradient(circle at 40% 85%, rgba(0,0,0,.04), transparent 50%),
                  #ffffff;
      z-index: 1;
      pointer-events:none;
    }
    .prizeInner{
      max-width: 620px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(22,122,166,.18);
      font-weight: 900;
      letter-spacing:.2px;
      margin-bottom: 10px;
    }
    .prizeTitle{
      font-size: 40px;
      font-weight: 900;
      margin: 0;
      letter-spacing: .3px;
    }
    .prizeCode{
      margin-top: 10px;
      font-weight: 900;
      font-size: 16px;
      color:#20324a;
    }
    .prizeNote{
      margin-top: 8px;
      font-size: 13px;
      font-weight: 700;
      color:#4a6077;
    }

    /* Scratch canvas (top) */
    #scratchCanvas{
      position:absolute;
      inset:0;
      z-index: 2;
      display:block;
      /* Important: canvas only captures touches inside the scratch area */
      touch-action: none;
    }
    .scratchDisabled #scratchCanvas{
      opacity: .35;
      pointer-events:none;
    }

    /* Bottom buttons */
    .footerActions{
      display:flex;
      gap: 12px;
      justify-content:flex-end;
      padding: 14px;
      border-top: 1px dashed #e6eef7;
      background: #fff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="titleBlock">
          <h1 class="title">Scratch to Win</h1>
          <p class="subtitle">AOA Optometry‚Äôs Meeting ‚Ä¢ Phoenix 2026</p>
        </div>

        <!-- ‚úÖ per your requested logo markup -->
        <div class="logoRow">
          <div class="logoBox"><img src="assets/aoa-logo.jpeg" alt="AOA Logo"></div>
          <div class="logoBox"><img src="assets/odgo-logo.jpeg" alt="OD on the GO Logo"></div>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div>
            <label for="name">Full Name</label>
            <input id="name" type="text" placeholder="Full name" autocomplete="name" />
          </div>
          <div>
            <label for="email">Email Address</label>
            <input id="email" type="email" placeholder="name@email.com" autocomplete="email" />
          </div>
        </div>

        <div class="actions">
          <button id="saveBtn" class="primary">Save ‚Äî scratch below!</button>
          <button id="nextBtn" disabled>Next Student</button>
        </div>

        <div id="status" class="status"></div>

        <div id="scratchWrap" class="scratchWrap scratchDisabled">
          <div class="scratchHead">
            <div>Scratch to reveal your prize</div>
            <div class="inv" id="invText">Inventory remaining: ‚Äî</div>
          </div>

          <div class="scratchStage" id="scratchStage">
            <!-- Prize (under layer) -->
            <div class="prizeLayer">
              <div class="prizeInner">
                <div class="pill">YOUR PRIZE</div>
                <h2 class="prizeTitle" id="prizeTitle">‚Äî</h2>
                <div class="prizeCode" id="prizeCode">Code: ‚Äî</div>
                <div class="prizeNote">Scratch the gray card to reveal your discount.</div>
              </div>
            </div>

            <!-- Scratch overlay -->
            <canvas id="scratchCanvas"></canvas>
          </div>

          <!-- Buttons moved to bottom to avoid accidental taps -->
          <div class="footerActions">
            <button id="exportBtn">Export CSV</button>
            <button id="resetBtn">Reset Device Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Inventory + Storage *
     ***********************/
    const LS_INV = "odgo_scratch_inventory_v2";
    const LS_LEADS = "odgo_scratch_leads_v2";

    // ‚úÖ YOUR INVENTORY (truly random from remaining items)
    //  - 2 free Part 1 (unique codes)
    //  - 2 free Part 2 (unique codes)
    //  - 2 free Part 3 (unique codes)
    //  - 50 x $50 off (same code)
    //  - 400 x 20% off (same code)
    function buildFreshInventory(){
      const items = [];

      // temporary unique codes (replace later)
      items.push({ prize: "FREE PART 1 COURSE", code: "FREEP1-AOA-01" });
      items.push({ prize: "FREE PART 1 COURSE", code: "FREEP1-AOA-02" });

      items.push({ prize: "FREE PART 2 COURSE", code: "FREEP2-AOA-01" });
      items.push({ prize: "FREE PART 2 COURSE", code: "FREEP2-AOA-02" });

      items.push({ prize: "FREE PART 3 COURSE", code: "FREEP3-AOA-01" });
      items.push({ prize: "FREE PART 3 COURSE", code: "FREEP3-AOA-02" });

      // same-code buckets
      for (let i = 0; i < 50; i++){
        items.push({ prize: "$50 OFF ANY COURSE", code: "ODGO50" });
      }
      for (let i = 0; i < 400; i++){
        items.push({ prize: "20% OFF ANY COURSE", code: "ODGO20" });
      }

      return items;
    }

    function loadInventory(){
      const raw = localStorage.getItem(LS_INV);
      if (!raw){
        const fresh = buildFreshInventory();
        localStorage.setItem(LS_INV, JSON.stringify(fresh));
        return fresh;
      }
      try{
        const inv = JSON.parse(raw);
        return Array.isArray(inv) ? inv : buildFreshInventory();
      }catch(e){
        const fresh = buildFreshInventory();
        localStorage.setItem(LS_INV, JSON.stringify(fresh));
        return fresh;
      }
    }

    function saveInventory(inv){
      localStorage.setItem(LS_INV, JSON.stringify(inv));
      updateInventoryText(inv);
    }

    function loadLeads(){
      const raw = localStorage.getItem(LS_LEADS);
      if (!raw) return [];
      try{
        const leads = JSON.parse(raw);
        return Array.isArray(leads) ? leads : [];
      }catch(e){
        return [];
      }
    }

    function saveLeads(leads){
      localStorage.setItem(LS_LEADS, JSON.stringify(leads));
    }

    function updateInventoryText(inv){
      invText.textContent = `Inventory remaining: ${inv.length}`;
    }

    // Truly random draw from remaining
    function drawRandomPrize(inv){
      if (!inv.length) return null;
      const idx = Math.floor(Math.random() * inv.length);
      const pick = inv[idx];
      inv.splice(idx, 1); // remove it
      return pick;
    }

    /**********************
     * Scratch mechanics  *
     **********************/
    const scratchWrap = document.getElementById("scratchWrap");
    const stage = document.getElementById("scratchStage");
    const canvas = document.getElementById("scratchCanvas");
    const ctx = canvas.getContext("2d");

    const prizeTitleEl = document.getElementById("prizeTitle");
    const prizeCodeEl = document.getElementById("prizeCode");

    let isPointerDown = false;
    let revealed = false;
    let scratchedRatio = 0;

    // ‚úÖ Lower requirement so it reveals easily on iPad
    const REVEAL_THRESHOLD = 0.10; // 10%

    // For the current student
    let currentPrize = null;
    let currentLead = null;
    let currentLeadSaved = false;

    function resizeCanvas(){
      const r = stage.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width  = Math.floor(r.width * dpr);
      canvas.height = Math.floor(r.height * dpr);
      canvas.style.width = r.width + "px";
      canvas.style.height = r.height + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);

      // redraw scratch layer if needed
      drawScratchLayer();
    }

    function drawScratchLayer(){
      const w = stage.getBoundingClientRect().width;
      const h = stage.getBoundingClientRect().height;

      // gray card
      ctx.globalCompositeOperation = "source-over";
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "#bdbdbd";
      ctx.fillRect(0,0,w,h);

      // subtle label
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.font = "800 30px Manrope, system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("SCRATCH HERE", w/2, h/2 + 10);

      // set to erase mode when scratching
      ctx.globalCompositeOperation = "destination-out";

      scratchedRatio = 0;
      revealed = false;
    }

    function scratchAt(clientX, clientY){
      const rect = canvas.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      // brush
      ctx.beginPath();
      ctx.arc(x, y, 26, 0, Math.PI*2);
      ctx.fill();

      // check reveal progress occasionally
      checkRevealProgressThrottled();
    }

    let lastCheck = 0;
    function checkRevealProgressThrottled(){
      const now = Date.now();
      if (now - lastCheck < 220) return;
      lastCheck = now;
      scratchedRatio = estimateScratchedRatio();
      if (!revealed && scratchedRatio >= REVEAL_THRESHOLD){
        revealed = true;
        // optional: clear remaining layer for a clean reveal
        revealAll();
      }
      // enable next after FIRST scratch stroke (not waiting for threshold)
      enableNextStudentAfterFirstScratch();
    }

    function estimateScratchedRatio(){
      // sample grid for speed
      const w = stage.getBoundingClientRect().width;
      const h = stage.getBoundingClientRect().height;
      const img = ctx.getImageData(0,0,w,h).data;
      let transparent = 0;
      let total = 0;

      const step = 12; // sampling step (performance)
      for (let y = 0; y < h; y += step){
        for (let x = 0; x < w; x += step){
          const i = ((y*w) + x) * 4 + 3; // alpha channel
          const a = img[i];
          total++;
          if (a === 0) transparent++;
        }
      }
      return total ? (transparent / total) : 0;
    }

    function revealAll(){
      const w = stage.getBoundingClientRect().width;
      const h = stage.getBoundingClientRect().height;
      // clear canvas fully
      ctx.globalCompositeOperation = "source-over";
      ctx.clearRect(0,0,w,h);
      ctx.globalCompositeOperation = "destination-out";
    }

    function enableScratch(){
      scratchWrap.classList.remove("scratchDisabled");
      canvas.style.pointerEvents = "auto";
    }
    function disableScratch(){
      scratchWrap.classList.add("scratchDisabled");
      canvas.style.pointerEvents = "none";
    }

    function attachScratchEvents(){
      // Pointer events (works for mouse + touch + pencil)
      canvas.addEventListener("pointerdown", (e) => {
        if (!currentLeadSaved) return; // must save first
        isPointerDown = true;
        canvas.setPointerCapture?.(e.pointerId);
        scratchAt(e.clientX, e.clientY);
      });

      canvas.addEventListener("pointermove", (e) => {
        if (!isPointerDown) return;
        scratchAt(e.clientX, e.clientY);
      });

      const end = () => { isPointerDown = false; };
      canvas.addEventListener("pointerup", end);
      canvas.addEventListener("pointercancel", end);
      canvas.addEventListener("pointerleave", end);
    }

    /**********************
     * Confetti (FREE only)
     **********************/
    function launchConfetti(){
      const duration = 2000;
      const end = Date.now() + duration;

      (function frame(){
        const timeLeft = end - Date.now();
        if (timeLeft <= 0) return;

        const particleCount = 12;
        for (let i = 0; i < particleCount; i++) {
          const conf = document.createElement("div");
          conf.style.position = "fixed";
          conf.style.width = "8px";
          conf.style.height = "14px";
          conf.style.background = `hsl(${Math.random()*360}, 90%, 55%)`;
          conf.style.top = "50%";
          conf.style.left = "50%";
          conf.style.zIndex = "9999";
          conf.style.borderRadius = "2px";
          conf.style.pointerEvents = "none";
          conf.style.transition = "all 1.2s ease-out";
          document.body.appendChild(conf);

          const angle = Math.random() * 2 * Math.PI;
          const distance = 250 + Math.random() * 250;
          const x = Math.cos(angle) * distance;
          const y = Math.sin(angle) * distance;

          setTimeout(() => {
            conf.style.transform = `translate(${x}px, ${y}px) rotate(${Math.random()*720}deg)`;
            conf.style.opacity = "0";
          }, 10);

          setTimeout(() => conf.remove(), 1300);
        }
        requestAnimationFrame(frame);
      })();
    }

    /**********************
     * UI + Flow
     **********************/
    const nameEl = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const saveBtn = document.getElementById("saveBtn");
    const nextBtn = document.getElementById("nextBtn");
    const exportBtn = document.getElementById("exportBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusEl = document.getElementById("status");
    const invText = document.getElementById("invText");

    let inventory = loadInventory();
    let leads = loadLeads();
    updateInventoryText(inventory);

    function setStatus(html){
      statusEl.innerHTML = html;
      statusEl.classList.add("show");
    }
    function clearStatus(){
      statusEl.classList.remove("show");
      statusEl.innerHTML = "";
    }

    function validateEmail(v){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v).trim());
    }

    function prepareNewStudent(){
      clearStatus();

      nameEl.value = "";
      emailEl.value = "";
      currentLead = null;
      currentPrize = null;
      currentLeadSaved = false;

      // reset prize display
      prizeTitleEl.textContent = "‚Äî";
      prizeCodeEl.textContent = "Code: ‚Äî";

      // reset scratch layer
      resizeCanvas();
      drawScratchLayer();
      disableScratch();

      // buttons
      saveBtn.disabled = false;
      nextBtn.disabled = true; // enable after first scratch
      saveBtn.textContent = "Save ‚Äî scratch below!";
    }

    function pickPrizeForCurrentStudent(){
      // draw + persist inventory immediately (so it can‚Äôt be re-awarded)
      const pick = drawRandomPrize(inventory);
      saveInventory(inventory);
      return pick;
    }

    function onSave(){
      const name = nameEl.value.trim();
      const email = emailEl.value.trim();

      if (!name){
        setStatus(`<b>Please enter a name.</b>`);
        return;
      }
      if (!validateEmail(email)){
        setStatus(`<b>Please enter a valid email.</b>`);
        return;
      }
      if (!inventory.length){
        setStatus(`<b>Inventory is empty.</b><small>No prizes remaining on this device.</small>`);
        return;
      }

      // assign a prize for this student
      currentPrize = pickPrizeForCurrentStudent();

      // show prize under the scratch
      prizeTitleEl.textContent = currentPrize.prize;
      prizeCodeEl.textContent = `Code: ${currentPrize.code}`;

      // create lead record (only saved ONCE per student)
      currentLead = {
        name,
        email,
        prize: currentPrize.prize,
        code: currentPrize.code,
        timestamp: new Date().toISOString()
      };

      // ‚úÖ Save lead once here (NOT again on scratch)
      leads.push(currentLead);
      saveLeads(leads);

      currentLeadSaved = true;
      setStatus(`<b>Saved ‚úÖ</b><small>${name} ‚Äî ${email} (saved). Now scratch below to reveal your prize.</small>`);

      // enable scratch
      enableScratch();

      // lock save so you can‚Äôt double-save the same student
      saveBtn.disabled = true;
      saveBtn.textContent = "Saved ‚Äî scratch below!";
    }

    function enableNextStudentAfterFirstScratch(){
      if (!nextBtn.disabled) return;

      nextBtn.disabled = false;

      // üéâ Confetti only for FREE courses
      if (currentPrize && String(currentPrize.prize).includes("FREE PART")){
        launchConfetti();
      }
    }

    function onNextStudent(){
      // just move to next; inventory + leads already saved
      prepareNewStudent();
      // scroll back up a touch (nice on iPad)
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function exportCSV(){
      const rows = loadLeads();
      if (!rows.length){
        alert("No leads yet.");
        return;
      }
      const headers = ["Name","Email","Prize","Code","Timestamp"];
      const csv = [
        headers.join(","),
        ...rows.map(r => [
          csvEscape(r.name),
          csvEscape(r.email),
          csvEscape(r.prize),
          csvEscape(r.code),
          csvEscape(r.timestamp)
        ].join(","))
      ].join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "odgo_conference_leads.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function csvEscape(val){
      const s = String(val ?? "");
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    function resetDeviceData(){
      const ok = confirm("Reset THIS device‚Äôs inventory + saved leads?");
      if (!ok) return;
      localStorage.removeItem(LS_INV);
      localStorage.removeItem(LS_LEADS);
      inventory = loadInventory();
      leads = loadLeads();
      updateInventoryText(inventory);
      prepareNewStudent();
      alert("Device data reset.");
    }

    // Fix for your ‚Äúcan‚Äôt press Next Student‚Äù:
    // 1) Make sure the canvas is ONLY inside the scratch area (it is)
    // 2) Ensure nothing invisible is covering the Next button
    //    (canvas z-index stays within scratchStage; Next is above it)
    // 3) Also ensure scratchWrap doesn‚Äôt overlap buttons (it doesn‚Äôt)

    /**********************
     * Init
     **********************/
    window.addEventListener("resize", resizeCanvas);

    saveBtn.addEventListener("click", onSave);
    nextBtn.addEventListener("click", onNextStudent);
    exportBtn.addEventListener("click", exportCSV);
    resetBtn.addEventListener("click", resetDeviceData);

    attachScratchEvents();
    prepareNewStudent();
    updateInventoryText(inventory);
  </script>
</body>
</html>

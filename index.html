<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OD on the GO â€” Conference Scratcher</title>

<style>
body { font-family: Arial, sans-serif; background:#fafafa; margin:0; }
.wrap { max-width: 600px; margin: 30px auto; padding: 0 16px; text-align:center; }

h2 { margin-bottom:6px; }
.sub { display:none; }

.card {
  background:#fff;
  border:1px solid #eee;
  border-radius:16px;
  padding:18px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}

label { display:block; text-align:left; font-weight:700; margin-top:12px; }
input {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-top:6px;
  font-size:16px;
  box-sizing:border-box;
}

.btnRow { margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
button {
  padding:12px 16px;
  border-radius:10px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
button:disabled{ opacity:0.55; cursor:not-allowed; }
.primary { background:#111; color:#fff; }
.secondary { background:#f0f0f0; }

.scratchCard {
  margin-top:22px;
  position:relative;
  max-width:520px;
  margin-left:auto;
  margin-right:auto;
}

.scratchUnder {
  position:absolute;
  inset:0;
  background:#fff;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:26px;
  border:1px solid #ddd;
  z-index:0;
}

canvas {
  width:100%;
  height:auto;
  border-radius:14px;
  border:1px solid #ddd;
  touch-action:none;
  position:relative;
  z-index:1;
}

.foot { display:none; }
</style>
</head>

<body>
<div class="wrap">
<h2>ðŸŽ‰ OD on the GO Conference Scratcher</h2>

<div class="card">

<label>Name</label>
<input id="nameInput" type="text" placeholder="First + last name">

<label>Email</label>
<input id="emailInput" type="email" placeholder="name@email.com">

<div class="btnRow">
  <button id="saveBtn" class="primary" type="button">Save â€” scratch below!</button>
  <button id="nextBtn" class="secondary" type="button" disabled>Next Student</button>
</div>

<div class="scratchCard">
  <div class="scratchUnder">
    <div id="prizeText">â€”</div>
    <div style="font-size:14px;margin-top:6px;" id="codeText"></div>
  </div>
  <canvas id="scratchCanvas" width="600" height="240"></canvas>
</div>

<!-- Admin buttons moved to bottom -->
<div class="btnRow" style="margin-top:20px;">
  <button id="exportBtn" class="secondary" type="button">Export CSV</button>
  <button id="resetAllBtn" class="secondary" type="button">Reset Device Data</button>
</div>

</div>
</div>

<script>
(() => {

const STORAGE_KEY = "odgo_conf_inventory_v1";
const LEADS_KEY = "odgo_conf_leads_v1";

const inventoryTemplate = {
  freeP1: 2,
  freeP2: 2,
  freeP3: 2,
  fifty: 50,
  twenty: 500
};

function loadInventory(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {...inventoryTemplate};
}
function saveInventory(inv){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(inv));
}
function loadLeads(){
  return JSON.parse(localStorage.getItem(LEADS_KEY)) || [];
}
function saveLeads(arr){
  localStorage.setItem(LEADS_KEY, JSON.stringify(arr));
}
function validEmail(s){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
}

// Choose a prize from what's still available
function choosePrize(inv){
  const pool = [];
  if(inv.freeP1 > 0) pool.push("FREE PART 1");
  if(inv.freeP2 > 0) pool.push("FREE PART 2");
  if(inv.freeP3 > 0) pool.push("FREE PART 3");
  if(inv.fifty  > 0) pool.push("$50 OFF");
  if(inv.twenty > 0) pool.push("20% OFF");

  if(!pool.length){
    return { label:"SOLD OUT", code:"" };
  }

  const pick = pool[Math.floor(Math.random()*pool.length)];
  switch(pick){
    case "FREE PART 1": inv.freeP1--; return {label:pick, code:"FREEP1TMP"};
    case "FREE PART 2": inv.freeP2--; return {label:pick, code:"FREEP2TMP"};
    case "FREE PART 3": inv.freeP3--; return {label:pick, code:"FREEP3TMP"};
    case "$50 OFF":     inv.fifty--;  return {label:pick, code:"CONF50TMP"};
    default:            inv.twenty--; return {label:"20% OFF", code:"CONF20TMP"};
  }
}

const canvas = document.getElementById("scratchCanvas");
const ctx = canvas.getContext("2d");

function drawCover(){
  ctx.globalCompositeOperation="source-over";
  ctx.fillStyle="#bfbfbf";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="rgba(0,0,0,0.35)";
  ctx.font="bold 28px Arial";
  ctx.textAlign="center";
  ctx.fillText("SCRATCH HERE", canvas.width/2, canvas.height/2);
  ctx.globalCompositeOperation="destination-out";
}

function scratchDot(x,y){
  ctx.beginPath();
  ctx.arc(x,y,34,0,Math.PI*2);
  ctx.fill();
}

function getPos(e){
  const r=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return {
    x:(t.clientX-r.left)*(canvas.width/r.width),
    y:(t.clientY-r.top )*(canvas.height/r.height)
  };
}

// âœ… LOWER completion requirement (15%)
function percentCleared(){
  const img = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let cleared=0;
  for(let i=3;i<img.length;i+=4){
    if(img[i]===0) cleared++;
  }
  return cleared/(img.length/4);
}

let scratching=false;
let currentLead=null;   // becomes non-null AFTER Save
let currentPrize=null;
let revealed=false;

// âœ… small debounce to prevent double-tap save duplicates
let lastSaveAt = 0;

function checkReveal(){
  if(revealed) return;
  const pct = percentCleared();
  if(pct >= 0.15){
    revealed = true;
    // nothing else needed; prize is already visible underneath as you scratch
  }
}

canvas.addEventListener("mousedown",e=>{
  if(!currentLead) return;
  scratching=true;
  const p=getPos(e);
  scratchDot(p.x,p.y);
  checkReveal();
});
canvas.addEventListener("mousemove",e=>{
  if(!scratching||!currentLead) return;
  const p=getPos(e);
  scratchDot(p.x,p.y);
  checkReveal();
});
window.addEventListener("mouseup",()=>scratching=false);

canvas.addEventListener("touchstart",e=>{
  if(!currentLead) return;
  scratching=true;
  const p=getPos(e);
  scratchDot(p.x,p.y);
  checkReveal();
  e.preventDefault();
},{passive:false});
canvas.addEventListener("touchmove",e=>{
  if(!scratching||!currentLead) return;
  const p=getPos(e);
  scratchDot(p.x,p.y);
  checkReveal();
  e.preventDefault();
},{passive:false});
canvas.addEventListener("touchend",()=>scratching=false);

const saveBtn = document.getElementById("saveBtn");
const nextBtn = document.getElementById("nextBtn");

saveBtn.addEventListener("click",()=>{
  const now = Date.now();
  if(now - lastSaveAt < 700) return; // âœ… debounce
  lastSaveAt = now;

  // âœ… block duplicate saves until Next Student
  if(currentLead){
    alert("Already saved. Tap Next Student for the next entry.");
    return;
  }

  const name=document.getElementById("nameInput").value.trim();
  const email=document.getElementById("emailInput").value.trim();
  if(!name){ alert("Enter a name."); return; }
  if(!validEmail(email)){ alert("Enter a valid email."); return; }

  const inv=loadInventory();
  const prize=choosePrize(inv);
  saveInventory(inv);

  currentPrize=prize;
  revealed=false;

  document.getElementById("prizeText").textContent=prize.label;
  document.getElementById("codeText").textContent=prize.code ? ("Code: "+prize.code) : "";

  const leads=loadLeads();
  currentLead={name,email,prize:prize.label,code:prize.code,time:new Date().toISOString()};
  leads.push(currentLead);
  saveLeads(leads);

  drawCover();

  // âœ… lock Save until Next Student
  saveBtn.disabled = true;
  nextBtn.disabled = false;
});

nextBtn.addEventListener("click",()=>{
  document.getElementById("nameInput").value="";
  document.getElementById("emailInput").value="";
  document.getElementById("prizeText").textContent="â€”";
  document.getElementById("codeText").textContent="";
  currentLead=null;
  currentPrize=null;
  revealed=false;

  saveBtn.disabled = false;
  nextBtn.disabled = true;

  drawCover();
});

document.getElementById("exportBtn").addEventListener("click",()=>{
  const leads=loadLeads();
  if(!leads.length){ alert("No leads yet."); return; }
  const header="Name,Email,Prize,Code,Timestamp\n";
  const rows=leads.map(l=>{
    const esc = (v)=> `"${String(v ?? "").replaceAll('"','""')}"`;
    return [esc(l.name),esc(l.email),esc(l.prize),esc(l.code),esc(l.time)].join(",");
  }).join("\n");

  const blob=new Blob([header+rows],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="odgo_conference_leads.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById("resetAllBtn").addEventListener("click",()=>{
  if(confirm("Reset ALL inventory and leads on this device?")){
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(LEADS_KEY);
    alert("Device reset.");
  }
});

// init
drawCover();

})();
</script>

</body>
</html>

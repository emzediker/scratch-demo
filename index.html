<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OD on the GO — Conference Scratcher</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f5f8;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --accent:#0F6E8C;
      --accent2:#2A9DBB;
      --btn:#0b0f14;
      --btnText:#fff;
      --soft:#f8fafc;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    .wrap{
      max-width: 980px;
      margin: 18px auto 26px;
      padding: 0 14px;
    }

    /* ===== Header ===== */
    .header{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      padding: 18px 20px;
      color:#fff;
      border-radius: 18px 18px 0 0;
    }
    .headerInner{
      max-width: 940px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
      flex-wrap:wrap;
    }
    .headerTitleWrap{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .header h1{
      margin:0;
      font-family:'Montserrat', Arial, sans-serif;
      font-weight:800;
      font-size:30px;
      letter-spacing:.2px;
    }
    .header p{
      margin:0;
      font-family:'Montserrat', Arial, sans-serif;
      font-weight:600;
      font-size:14px;
      opacity:.95;
    }
    .logoRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .logoBox{
      height:44px;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.22);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .logoBox img{
      height:32px;
      width:auto;
      display:block;
      object-fit:contain;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.15));
    }

    /* ===== Main Card ===== */
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-top: none;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }
    @media (max-width: 760px){
      .grid{grid-template-columns:1fr}
    }

    label{
      display:block;
      font-weight:800;
      font-family:'Montserrat', Arial, sans-serif;
      font-size:13px;
      margin-bottom:6px;
      color: var(--ink);
    }
    input{
      width:100%;
      padding:14px 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color: rgba(42,157,187,.65);
      box-shadow: 0 0 0 4px rgba(42,157,187,.12);
    }

    .btnRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:14px;
      align-items:center;
      justify-content:flex-start;
    }
    .btn{
      border:none;
      background: var(--btn);
      color: var(--btnText);
      border-radius: 14px;
      padding: 12px 18px;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      min-width: 170px;
    }
    .btn.secondary{
      background:#fff;
      color: var(--ink);
      border:1px solid var(--line);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .status{
      margin-top:12px;
      border:1px solid #cfe7ff;
      background:#f0f7ff;
      border-radius: 14px;
      padding: 12px 14px;
      color:#0b3a77;
      display:none;
    }
    .status strong{font-family:'Montserrat', Arial, sans-serif}

    .scratchHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 16px;
      margin-bottom: 10px;
    }
    .scratchHeader h3{
      margin:0;
      font-family:'Montserrat', Arial, sans-serif;
      font-weight:800;
      font-size:18px;
      color: var(--ink);
    }
    .inv{
      color: var(--muted);
      font-size:13px;
      font-family:'Montserrat', Arial, sans-serif;
      font-weight:600;
    }

    .scratchStage{
      position:relative;
      width:100%;
      border:1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      background: linear-gradient(135deg, rgba(15,110,140,.10), rgba(42,157,187,.10));
      min-height: 310px;
    }
    .underlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: 26px 18px;
      text-align:center;
      pointer-events:none;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.65);
      padding: 8px 12px;
      border-radius: 999px;
      font-family:'Montserrat', Arial, sans-serif;
      font-weight:800;
      color:#0f172a;
      margin-bottom: 14px;
    }
    .prizeBig{
      font-family:'Montserrat', Arial, sans-serif;
      font-weight:800;
      font-size: 38px;
      line-height:1.05;
      margin: 0;
      color:#0f172a;
    }
    .codeLine{
      margin-top: 10px;
      font-size: 16px;
      color: #0f172a;
      font-family:'Montserrat', Arial, sans-serif;
      font-weight:700;
    }
    .codeLine span{
      font-weight:800;
      letter-spacing:.6px;
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
    }

    .admin{
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px dashed var(--line);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .admin .btn{ min-width: 190px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="headerInner">
        <div class="headerTitleWrap">
          <h1>Scratch to Win</h1>
          <p>AOA Optometry’s Meeting • Phoenix 2026</p>
        </div>

        <div class="logoRow">
          <div class="logoBox"><img src="assets/aoa-logo.jpeg" alt="AOA Logo"></div>
          <div class="logoBox"><img src="assets/odgo-logo.jpeg" alt="OD on the GO Logo"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="name">Full Name</label>
          <input id="name" type="text" placeholder="Full name" autocomplete="name" />
        </div>
        <div>
          <label for="email">Email Address</label>
          <input id="email" type="email" placeholder="name@email.com" autocomplete="email" />
        </div>
      </div>

      <div class="btnRow">
        <button id="saveBtn" class="btn" type="button">Save — scratch below!</button>
        <button id="nextBtn" class="btn secondary" type="button" disabled>Next Student</button>
      </div>

      <div id="status" class="status">
        <strong>Saved ✅</strong>
        <div id="statusText" style="margin-top:6px;"></div>
      </div>

      <div class="scratchHeader">
        <h3>Scratch to reveal your prize</h3>
        <div class="inv">Inventory remaining: <span id="invCount">—</span></div>
      </div>

      <div class="scratchStage" id="scratchStage">
        <div class="underlay">
          <div class="pill">YOUR PRIZE</div>
          <p class="prizeBig" id="prizeLabel">—</p>
          <div class="codeLine">Code: <span id="prizeCode">—</span></div>
        </div>
        <canvas id="scratchCanvas"></canvas>
      </div>

      <div class="admin">
        <button id="exportBtn" class="btn secondary" type="button">Export CSV</button>
        <button id="resetBtn" class="btn secondary" type="button">Reset Device Data</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /* =========================
     CONFIG — EDIT CODES LATER
     ========================= */
  const CODES = {
    OFF50: "ODGO50",
    OFF20: "ODGO20",
    FREE_P1: ["FREEP1-1", "FREEP1-2"],
    FREE_P2: ["FREEP2-1", "FREEP2-2"],
    FREE_P3: ["FREEP3-1", "FREEP3-2"],
  };

  const COUNTS = {
    FREE_P1: 2,
    FREE_P2: 2,
    FREE_P3: 2,
    OFF50: 50,
    OFF20: 400, // ✅ increased to 400
  };

  const SCRATCH_THRESHOLD = 0.25; // easier
  const BRUSH_RADIUS = 34;

  const K_LEADS = "odgo_aoa2026_leads_v1";
  const K_INV   = "odgo_aoa2026_inventory_v1";

  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");
  const saveBtn = document.getElementById("saveBtn");
  const nextBtn = document.getElementById("nextBtn");
  const exportBtn = document.getElementById("exportBtn");
  const resetBtn = document.getElementById("resetBtn");

  const status = document.getElementById("status");
  const statusText = document.getElementById("statusText");

  const invCount = document.getElementById("invCount");
  const prizeLabelEl = document.getElementById("prizeLabel");
  const prizeCodeEl  = document.getElementById("prizeCode");

  const stage = document.getElementById("scratchStage");
  const canvas = document.getElementById("scratchCanvas");
  const ctx = canvas.getContext("2d");

  let currentLeadId = null;
  let scratchEnabled = false;
  let scratching = false;
  let revealed = false;

  function validEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
  }
  function uid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));
  }
  function nowISO(){ return new Date().toISOString(); }

  function getLeads(){
    try { return JSON.parse(localStorage.getItem(K_LEADS) || "[]"); }
    catch { return []; }
  }
  function setLeads(arr){
    localStorage.setItem(K_LEADS, JSON.stringify(arr));
  }
  function getInv(){
    try { return JSON.parse(localStorage.getItem(K_INV) || "[]"); }
    catch { return []; }
  }
  function setInv(arr){
    localStorage.setItem(K_INV, JSON.stringify(arr));
  }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function buildInventory(){
    const inv = [];
    for (let i=0;i<COUNTS.FREE_P1;i++){
      inv.push({ type:"FREE_P1", label:"FREE PART 1", code: CODES.FREE_P1[i] || ("FREEP1-"+(i+1)) });
    }
    for (let i=0;i<COUNTS.FREE_P2;i++){
      inv.push({ type:"FREE_P2", label:"FREE PART 2", code: CODES.FREE_P2[i] || ("FREEP2-"+(i+1)) });
    }
    for (let i=0;i<COUNTS.FREE_P3;i++){
      inv.push({ type:"FREE_P3", label:"FREE PART 3", code: CODES.FREE_P3[i] || ("FREEP3-"+(i+1)) });
    }
    for (let i=0;i<COUNTS.OFF50;i++){
      inv.push({ type:"OFF50", label:"$50 OFF ANY COURSE", code: CODES.OFF50 });
    }
    for (let i=0;i<COUNTS.OFF20;i++){
      inv.push({ type:"OFF20", label:"20% OFF ANY COURSE", code: CODES.OFF20 });
    }
    return shuffle(inv);
  }

  function ensureInventory(){
    let inv = getInv();
    if (!Array.isArray(inv) || inv.length === 0){
      inv = buildInventory();
      setInv(inv);
    }
    invCount.textContent = String(inv.length);
    return inv;
  }

  function pickPrizeFromInventory(){
    const inv = ensureInventory();
    if (inv.length === 0) return null;
    const prize = inv.shift(); // inventory is shuffled -> random
    setInv(inv);
    invCount.textContent = String(inv.length);
    return prize;
  }

  function resizeCanvasToStage(){
    const r = stage.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    canvas.width  = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    drawCover();
  }

  function drawCover(){
    const r = stage.getBoundingClientRect();
    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0, 0, r.width, r.height);

    ctx.fillStyle = "#bfbfbf";
    ctx.fillRect(0, 0, r.width, r.height);

    ctx.fillStyle = "rgba(0,0,0,0.40)";
    ctx.font = "800 22px Montserrat, Arial, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("SCRATCH HERE", r.width/2, r.height/2);

    ctx.globalCompositeOperation = "destination-out";
  }

  function getPos(evt){
    const r = stage.getBoundingClientRect();
    const t = evt.touches ? evt.touches[0] : evt;
    return { x: (t.clientX - r.left), y: (t.clientY - r.top) };
  }

  function scratchDot(x,y){
    ctx.beginPath();
    ctx.arc(x, y, BRUSH_RADIUS, 0, Math.PI*2);
    ctx.fill();
  }

  function percentCleared(){
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let cleared = 0;
    for (let i = 3; i < img.length; i += 4){
      if (img[i] === 0) cleared++;
    }
    return cleared / (img.length / 4);
  }

  function finishRevealIfNeeded(){
    if (revealed) return;
    const pct = percentCleared();
    if (pct >= SCRATCH_THRESHOLD){
      revealed = true;
      nextBtn.disabled = false;

      // ✅ allow taps to reach the Next Student button (iPad Safari fix)
      canvas.style.pointerEvents = "none";

      if (currentLeadId){
        const leads = getLeads();
        const idx = leads.findIndex(l => l.id === currentLeadId);
        if (idx !== -1){
          leads[idx].revealedAt = nowISO();
          setLeads(leads);
        }
      }
    }
  }

  function enableScratch(){
    scratchEnabled = true;
    revealed = false;
    nextBtn.disabled = true;

    // ✅ re-enable scratching for the next student
    canvas.style.pointerEvents = "auto";

    drawCover();
  }

  function disableScratch(){
    scratchEnabled = false;
    revealed = false;
    nextBtn.disabled = true;
    canvas.style.pointerEvents = "none";
    drawCover();
  }

  canvas.addEventListener("mousedown", (e) => {
    if (!scratchEnabled) return;
    scratching = true;
    const p = getPos(e);
    scratchDot(p.x, p.y);
    finishRevealIfNeeded();
  });
  canvas.addEventListener("mousemove", (e) => {
    if (!scratchEnabled || !scratching) return;
    const p = getPos(e);
    scratchDot(p.x, p.y);
    finishRevealIfNeeded();
  });
  window.addEventListener("mouseup", () => scratching = false);

  canvas.addEventListener("touchstart", (e) => {
    if (!scratchEnabled) return;
    scratching = true;
    const p = getPos(e);
    scratchDot(p.x, p.y);
    finishRevealIfNeeded();
    e.preventDefault();
  }, { passive:false });

  canvas.addEventListener("touchmove", (e) => {
    if (!scratchEnabled || !scratching) return;
    const p = getPos(e);
    scratchDot(p.x, p.y);
    finishRevealIfNeeded();
    e.preventDefault();
  }, { passive:false });

  canvas.addEventListener("touchend", () => scratching = false);

  function resetUIForNewStudent(){
    currentLeadId = null;

    nameEl.value = "";
    emailEl.value = "";
    nameEl.disabled = false;
    emailEl.disabled = false;

    saveBtn.disabled = false;
    saveBtn.textContent = "Save — scratch below!";

    status.style.display = "none";
    statusText.textContent = "";

    prizeLabelEl.textContent = "—";
    prizeCodeEl.textContent = "—";

    disableScratch();
  }

  saveBtn.addEventListener("click", () => {
    const name = (nameEl.value || "").trim();
    const email = (emailEl.value || "").trim();

    if (!name){ alert("Please enter your full name."); return; }
    if (!validEmail(email)){ alert("Please enter a valid email."); return; }

    const prize = pickPrizeFromInventory();
    if (!prize){
      alert("No prizes remaining on this device.");
      return;
    }

    const id = uid();
    const lead = {
      id,
      name,
      email,
      prizeLabel: prize.label,
      prizeCode: prize.code,
      savedAt: nowISO(),
      revealedAt: null
    };

    const leads = getLeads();
    leads.unshift(lead);
    setLeads(leads);

    currentLeadId = id;

    nameEl.disabled = true;
    emailEl.disabled = true;
    saveBtn.disabled = true;
    saveBtn.textContent = "Saved — scratch below!";

    status.style.display = "block";
    statusText.textContent = `${name} — ${email} (saved). Now scratch below to reveal your prize.`;

    prizeLabelEl.textContent = prize.label;
    prizeCodeEl.textContent = prize.code;

    enableScratch();
  });

  nextBtn.addEventListener("click", () => {
    resetUIForNewStudent();
  });

  exportBtn.addEventListener("click", () => {
    const leads = getLeads();
    if (!leads.length){
      alert("No leads yet.");
      return;
    }

    const header = "Name,Email,Prize,Code,TimestampSaved,TimestampRevealed\n";
    const rows = leads.map(l => {
      const esc = (s) => `"${String(s ?? "").replaceAll('"','""')}"`;
      return [
        esc(l.name),
        esc(l.email),
        esc(l.prizeLabel),
        esc(l.prizeCode),
        esc(l.savedAt),
        esc(l.revealedAt || "")
      ].join(",");
    }).join("\n");

    const blob = new Blob([header + rows], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "odgo_conference_leads.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  resetBtn.addEventListener("click", () => {
    if (!confirm("Reset all saved leads + remaining inventory on THIS device?")) return;
    localStorage.removeItem(K_LEADS);
    localStorage.removeItem(K_INV);
    ensureInventory();
    resetUIForNewStudent();
    alert("Device data cleared.");
  });

  ensureInventory();
  resizeCanvasToStage();
  resetUIForNewStudent();

  window.addEventListener("resize", () => resizeCanvasToStage());
  window.addEventListener("orientationchange", () => setTimeout(resizeCanvasToStage, 250));
})();
</script>

</body>
</html>

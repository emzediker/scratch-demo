<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OD on the GO — Conference Scratcher</title>

  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5a6b84;
      --line:#e6edf7;
      --accent:#1e7fa0; /* AOA-ish teal vibe */
      --accent2:#2aa6c9;
      --btn:#0b0f14;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 980px;
      margin: 22px auto;
      padding: 0 14px 24px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 6px 24px rgba(16,24,40,0.06);
    }

    /* Header bar */
    .hero{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#fff;
      padding: 18px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .heroLeft{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .heroTitle{
      font-size: 34px;
      font-weight: 900;
      letter-spacing:-0.4px;
      line-height:1.05;
      margin:0;
    }
    .heroSub{
      font-size: 14px;
      opacity: 0.92;
      margin:0;
      font-weight: 700;
    }
    .heroRight{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .logo{
      height: 36px;
      width: auto;
      border-radius: 8px;
      background: rgba(255,255,255,0.12);
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.20);
    }

    .content{
      padding: 18px 18px 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 6px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .hero{ align-items:flex-start; }
      .heroRight{ justify-content:flex-start; }
    }

    label{
      display:block;
      font-weight: 900;
      margin: 10px 0 6px;
      font-size: 13px;
      color: #1b2b44;
    }
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      font-size: 16px;
      outline: none;
      background:#fff;
    }
    input:disabled{
      background:#f7f9fd;
      color:#58667d;
    }

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
    }

    button{
      appearance:none;
      border:none;
      cursor:pointer;
      font-weight: 900;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      transition: transform .05s ease, opacity .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:0.55; cursor:not-allowed; }

    .primary{
      background: var(--btn);
      color:#fff;
      min-width: 200px;
    }
    .secondary{
      background:#fff;
      color:#0b1220;
      border: 1px solid var(--line);
      min-width: 160px;
    }

    .savedBox{
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid #cfe3ff;
      background:#eef6ff;
      padding: 12px 12px;
      display:none;
    }
    .savedBox .title{
      font-weight: 900;
      margin-bottom: 6px;
      color:#0b2b66;
    }

    /* Scratch area */
    .scratchWrap{
      margin-top: 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      overflow:hidden;
      background: #fff;
    }
    .scratchHeader{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      background: #fbfdff;
    }
    .scratchHeader .h{
      font-weight: 900;
      font-size: 18px;
      margin:0;
    }
    .inv{
      font-size: 13px;
      color: var(--muted);
      font-weight: 800;
    }

    .stage{
      position:relative;
      width: 100%;
      height: 290px;
      background: radial-gradient(circle at 25% 35%, rgba(30,127,160,0.12), transparent 55%),
                  radial-gradient(circle at 70% 45%, rgba(42,166,201,0.12), transparent 55%),
                  linear-gradient(#ffffff, #fbfbfd);
    }

    /* Underlay (the prize content) */
    .underlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      z-index: 0;
      pointer-events:none;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#ffffffcc;
      font-weight: 900;
      margin-bottom: 10px;
    }
    .prizeBig{
      font-size: 42px;
      font-weight: 1000;
      letter-spacing:-0.8px;
      margin: 0;
      line-height:1.08;
      color:#0b1220;
      text-transform: uppercase;
    }
    .prizeCode{
      margin-top: 10px;
      font-size: 16px;
      color:#1b2b44;
      font-weight: 900;
    }
    .prizeHint{
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }

    /* Canvas (scratch layer) */
    #scratchCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      z-index: 2;         /* on top until revealed */
      touch-action:none;
      background: transparent;
    }

    /* Bottom admin row (moved down to avoid accidental taps) */
    .adminBottom{
      padding: 12px 18px 18px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
      border-top: 1px dashed var(--line);
      margin-top: 10px;
    }

    .tinyNote{
      font-size: 12px;
      color: var(--muted);
      margin: 8px 0 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="hero">
        <div class="heroLeft">
          <h1 class="heroTitle">Scratch to Win</h1>
          <p class="heroSub">AOA Optometry’s Meeting • Phoenix 2026</p>
        </div>

        <!-- Replace src paths with your uploaded jpgs in your repo -->
        <div class="heroRight">
          <img class="logo" src="aoa.jpeg" alt="AOA logo">
          <img class="logo" src="odgo.jpeg" alt="OD on the GO logo">
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div>
            <label for="fullName">Full Name</label>
            <input id="fullName" type="text" placeholder="Full name" autocomplete="name" />
          </div>
          <div>
            <label for="email">Email Address</label>
            <input id="email" type="email" placeholder="name@email.com" autocomplete="email" />
          </div>
        </div>

        <div class="btnRow">
          <button id="saveBtn" class="primary" type="button">Save — scratch below!</button>
          <button id="nextBtn" class="secondary" type="button" disabled>Next Student</button>
        </div>

        <div id="savedBox" class="savedBox">
          <div class="title">Saved ✅</div>
          <div id="savedText" style="font-weight:800;color:#17315e;"></div>
        </div>

        <div class="scratchWrap">
          <div class="scratchHeader">
            <div class="h">Scratch to reveal your prize</div>
            <div class="inv">Inventory remaining: <span id="invCount">—</span></div>
          </div>

          <div class="stage">
            <!-- Prize content underneath -->
            <div class="underlay">
              <div class="pill">YOUR PRIZE</div>
              <p id="prizeLabel" class="prizeBig">—</p>
              <div id="prizeCode" class="prizeCode">Code: —</div>
              <div class="prizeHint">Scratch the gray card to reveal your discount.</div>
            </div>

            <!-- Scratch layer -->
            <canvas id="scratchCanvas" width="1200" height="520"></canvas>
          </div>
        </div>

        <p class="tinyNote"></p>
      </div>

      <!-- Admin buttons moved to bottom -->
      <div class="adminBottom">
        <button id="exportBtn" class="secondary" type="button">Export CSV</button>
        <button id="resetDeviceBtn" class="secondary" type="button">Reset Device Data</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // Storage Keys
  // =========================
  const LEADS_KEY = "odgo_conf_leads_v3";
  const INV_KEY   = "odgo_conf_inventory_v3";

  // =========================
  // Inventory Definition
  // (Update codes later)
  // =========================
  // You asked for: 2 Part 1 free, 2 Part 2 free, 2 Part 3 free (unique codes each),
  // 50 x $50 off (same code), and 400 x 20% off (same code).
  function buildFreshInventory() {
    const inv = [];

    // Free Part 1 (2 unique)
    inv.push({ prize: "FREE PART 1", code: "FREEP1-A" });
    inv.push({ prize: "FREE PART 1", code: "FREEP1-B" });

    // Free Part 2 (2 unique)
    inv.push({ prize: "FREE PART 2", code: "FREEP2-A" });
    inv.push({ prize: "FREE PART 2", code: "FREEP2-B" });

    // Free Part 3 (2 unique)
    inv.push({ prize: "FREE PART 3", code: "FREEP3-A" });
    inv.push({ prize: "FREE PART 3", code: "FREEP3-B" });

    // $50 off (50)
    for (let i = 0; i < 50; i++) inv.push({ prize: "$50 OFF ANY COURSE", code: "ODGO50" });

    // 20% off (400)
    for (let i = 0; i < 400; i++) inv.push({ prize: "20% OFF ANY COURSE", code: "ODGO20" });

    // Shuffle (true random order)
    shuffle(inv);
    return inv;
  }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function loadInventory(){
    try{
      const raw = localStorage.getItem(INV_KEY);
      if (!raw) {
        const fresh = buildFreshInventory();
        localStorage.setItem(INV_KEY, JSON.stringify(fresh));
        return fresh;
      }
      const inv = JSON.parse(raw);
      if (!Array.isArray(inv) || inv.length === 0){
        const fresh = buildFreshInventory();
        localStorage.setItem(INV_KEY, JSON.stringify(fresh));
        return fresh;
      }
      return inv;
    } catch {
      const fresh = buildFreshInventory();
      localStorage.setItem(INV_KEY, JSON.stringify(fresh));
      return fresh;
    }
  }

  function saveInventory(inv){
    localStorage.setItem(INV_KEY, JSON.stringify(inv));
  }

  function loadLeads(){
    try { return JSON.parse(localStorage.getItem(LEADS_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLeads(leads){
    localStorage.setItem(LEADS_KEY, JSON.stringify(leads));
  }

  function validEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
  }

  // =========================
  // DOM
  // =========================
  const fullNameEl = document.getElementById("fullName");
  const emailEl    = document.getElementById("email");
  const saveBtn    = document.getElementById("saveBtn");
  const nextBtn    = document.getElementById("nextBtn");
  const exportBtn  = document.getElementById("exportBtn");
  const resetDevBtn= document.getElementById("resetDeviceBtn");

  const savedBox   = document.getElementById("savedBox");
  const savedText  = document.getElementById("savedText");

  const invCountEl = document.getElementById("invCount");
  const prizeLabelEl = document.getElementById("prizeLabel");
  const prizeCodeEl  = document.getElementById("prizeCode");

  const canvas = document.getElementById("scratchCanvas");
  const ctx    = canvas.getContext("2d");

  // =========================
  // State
  // =========================
  let inventory = loadInventory();
  let currentPrize = null;
  let currentLeadIndex = null; // index in leads array for the active student
  let scratching = false;
  let currentPrizeRevealed = false;

  function updateInvUI(){
    invCountEl.textContent = String(inventory.length);
  }

  function setPrizeUI(prize){
    if (!prize){
      prizeLabelEl.textContent = "—";
      prizeCodeEl.textContent  = "Code: —";
      return;
    }
    prizeLabelEl.textContent = prize.prize;
    prizeCodeEl.textContent  = "Code: " + prize.code;
  }

  // =========================
  // Scratch Cover Drawing
  // =========================
  function drawCover(){
    // reset composite
    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // grey card
    ctx.fillStyle = "#bfbfbf";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // prompt text
    ctx.fillStyle = "rgba(0,0,0,0.40)";
    ctx.font = "900 52px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SCRATCH HERE", canvas.width/2, canvas.height/2);

    // erase mode
    ctx.globalCompositeOperation = "destination-out";

    // ensure canvas is interactive (until reveal)
    canvas.style.pointerEvents = "auto";
    canvas.style.zIndex = "2";
  }

  function getPos(evt){
    const r = canvas.getBoundingClientRect();
    const t = evt.touches ? evt.touches[0] : evt;
    return {
      x: (t.clientX - r.left) * (canvas.width / r.width),
      y: (t.clientY - r.top)  * (canvas.height / r.height)
    };
  }

  function scratchDot(x,y){
    ctx.beginPath();
    ctx.arc(x,y,30,0,Math.PI*2);
    ctx.fill();
  }

  function percentCleared(){
    // Downsample for speed: sample every Nth pixel
    const step = 8; // bigger = faster, less accurate
    const img = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    let cleared = 0;
    let total = 0;

    // alpha channel index = i+3
    const w = canvas.width;
    const h = canvas.height;

    for (let y = 0; y < h; y += step){
      for (let x = 0; x < w; x += step){
        const i = ((y * w + x) * 4) + 3;
        total++;
        if (img[i] === 0) cleared++;
      }
    }
    return cleared / total;
  }

  function checkScratchCompletion(){
    if (currentPrizeRevealed) return;
    const pct = percentCleared();

    // Lower threshold so it's easy on iPad
    if (pct > 0.10) {
      currentPrizeRevealed = true;

      // ✅ Make buttons clickable (canvas no longer intercepts taps)
      canvas.style.pointerEvents = "none";
      canvas.style.zIndex = "0";

      // enable Next Student
      nextBtn.disabled = false;

      // update the active lead record exactly once
      if (currentLeadIndex !== null) {
        const leads = loadLeads();
        if (leads[currentLeadIndex]) {
          leads[currentLeadIndex].prize = currentPrize?.prize || "";
          leads[currentLeadIndex].code  = currentPrize?.code  || "";
          leads[currentLeadIndex].timestamp = new Date().toISOString();
          saveLeads(leads);
        }
      }
    }
  }

  // =========================
  // Game flow
  // =========================
  function lockInputs(locked){
    fullNameEl.disabled = locked;
    emailEl.disabled = locked;
    saveBtn.disabled = locked;
  }

  function pickPrizeFromInventory(){
    if (inventory.length === 0) return null;
    // pop last (inventory already shuffled)
    const prize = inventory.pop();
    saveInventory(inventory);
    updateInvUI();
    return prize;
  }

  function startRoundForLead(name, email){
    currentPrizeRevealed = false;
    nextBtn.disabled = true;

    currentPrize = pickPrizeFromInventory();

    // Update prize underlay immediately (they won't "see" until scratched)
    setPrizeUI(currentPrize);

    // Draw cover on top
    drawCover();

    // Saved message
    savedBox.style.display = "block";
    savedText.textContent = `${name} — ${email} (saved). Now scratch below to reveal your prize.`;
  }

  function saveLead(){
    const name = (fullNameEl.value || "").trim();
    const email = (emailEl.value || "").trim();

    if (!name) { alert("Please enter a full name."); return; }
    if (!validEmail(email)) { alert("Please enter a valid email."); return; }
    if (inventory.length === 0) { alert("Inventory is empty. Reset device data to reload."); return; }

    // create lead entry FIRST (no duplicate lines)
    const leads = loadLeads();
    const newEntry = {
      name,
      email,
      prize: "",
      code: "",
      timestamp: "" // filled when scratched enough
    };
    leads.push(newEntry);
    saveLeads(leads);
    currentLeadIndex = leads.length - 1;

    // lock form
    lockInputs(true);
    saveBtn.textContent = "Saved — scratch below!";

    // start scratch round
    startRoundForLead(name, email);
  }

  function nextStudent(){
    // reset form
    fullNameEl.value = "";
    emailEl.value = "";
    lockInputs(false);
    saveBtn.textContent = "Save — scratch below!";
    savedBox.style.display = "none";
    currentLeadIndex = null;

    // reset scratch state
    currentPrize = null;
    currentPrizeRevealed = false;
    nextBtn.disabled = true;

    // blank prize UI until next save
    setPrizeUI(null);

    // reset scratch layer (so it shows grey again)
    drawCover();
  }

  // =========================
  // Canvas events
  // =========================
  function canScratch(){
    // only after lead is saved AND before reveal
    return saveBtn.disabled === true && currentPrize && !currentPrizeRevealed;
  }

  canvas.addEventListener("mousedown", (e)=>{
    if (!canScratch()) return;
    scratching = true;
    const p = getPos(e);
    scratchDot(p.x,p.y);
    checkScratchCompletion();
  });
  canvas.addEventListener("mousemove", (e)=>{
    if (!canScratch() || !scratching) return;
    const p = getPos(e);
    scratchDot(p.x,p.y);
    checkScratchCompletion();
  });
  window.addEventListener("mouseup", ()=> scratching = false);

  canvas.addEventListener("touchstart", (e)=>{
    if (!canScratch()) return;
    scratching = true;
    const p = getPos(e);
    scratchDot(p.x,p.y);
    checkScratchCompletion();
    e.preventDefault();
  }, { passive:false });

  canvas.addEventListener("touchmove", (e)=>{
    if (!canScratch() || !scratching) return;
    const p = getPos(e);
    scratchDot(p.x,p.y);
    checkScratchCompletion();
    e.preventDefault();
  }, { passive:false });

  canvas.addEventListener("touchend", ()=> scratching = false);

  // =========================
  // CSV Export
  // =========================
  function exportCSV(){
    const leads = loadLeads();
    if (!leads.length) { alert("No leads yet."); return; }

    const header = "Name,Email,Prize,Code,Timestamp\n";
    const rows = leads.map(l => {
      const esc = (v)=> `"${String(v ?? "").replaceAll('"','""')}"`;
      return [esc(l.name), esc(l.email), esc(l.prize), esc(l.code), esc(l.timestamp)].join(",");
    }).join("\n");

    const blob = new Blob([header + rows], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "odgo_conference_leads.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // =========================
  // Reset Device Data
  // =========================
  function resetDeviceData(){
    if (!confirm("This will delete saved leads + reset prize inventory on this device. Continue?")) return;
    localStorage.removeItem(LEADS_KEY);
    localStorage.removeItem(INV_KEY);
    inventory = loadInventory();
    updateInvUI();
    nextStudent();
    alert("Device data reset.");
  }

  // =========================
  // Wire Buttons
  // =========================
  saveBtn.addEventListener("click", saveLead);
  nextBtn.addEventListener("click", nextStudent);
  exportBtn.addEventListener("click", exportCSV);
  resetDevBtn.addEventListener("click", resetDeviceData);

  // =========================
  // Init
  // =========================
  updateInvUI();
  setPrizeUI(null);
  drawCover(); // show grey scratcher on load
})();
</script>
</body>
</html>

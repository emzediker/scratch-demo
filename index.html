<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OD on the GO — Conference Scratcher</title>
  <style>
    :root{
      --bg:#f2f5f8;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#5b667a;
      --line:#e4eaf1;
      --brand1:#1f86a8;   /* AOA-ish teal */
      --brand2:#2c9fbe;
      --btn:#111827;
      --btn2:#eef2f6;
      --ok:#1a7f37;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
    }
    .wrap{
      max-width: 1060px;
      margin: 22px auto;
      padding: 0 14px;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15,23,42,.06);
    }

    /* Header */
    .hero{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 16px;
      padding: 18px 18px 16px;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color: #fff;
    }
    .heroLeft h1{
      margin:0;
      font-size: 40px;
      line-height: 1.05;
      letter-spacing: -.02em;
      font-weight: 800;
    }
    .heroLeft .sub{
      margin-top: 6px;
      font-size: 14px;
      opacity: .95;
      letter-spacing: .02em;
      font-weight: 600;
    }

    .logoRow{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 2px;
    }
    .logoBox{
      width: 64px;            /* bigger */
      height: 64px;           /* bigger */
      border-radius: 12px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .logoBox img{
      width: 56px;            /* bigger */
      height: 56px;           /* bigger */
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.18));
    }

    /* Content */
    .content{
      padding: 18px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:end;
    }
    label{
      display:block;
      font-size: 13px;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 8px;
    }
    input{
      width:100%;
      padding: 14px 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size: 16px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color: rgba(31,134,168,.45);
      box-shadow: 0 0 0 4px rgba(31,134,168,.12);
    }

    .rowBtns{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 14px;
      flex-wrap: wrap;

      position: relative;
      z-index: 50; /* keep buttons tappable */
    }
    button{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 800;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .primary{
      background: var(--btn);
      color:#fff;
      border-color: rgba(0,0,0,.08);
    }
    .ghost{
      background: #fff;
      color: var(--ink);
    }
    .mutedBtn{
      background: #9aa3ad;
      color:#fff;
      border-color: rgba(0,0,0,.06);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .status{
      margin-top: 14px;
      padding: 12px 14px;
      background: #eef6ff;
      border: 1px solid #d8e9ff;
      border-radius: 12px;
      color: #0a3a78;
      font-weight: 700;
      display:none;
    }
    .status.ok{
      display:block;
    }
    .status .small{
      display:block;
      margin-top: 4px;
      font-weight: 600;
      opacity: .9;
      font-size: 13px;
    }

    /* Scratch card */
    .scratchCard{
      margin-top: 16px;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background: #fff;
    }
    .scratchTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background:#fbfcfe;
    }
    .scratchTop .title{
      font-weight: 900;
      font-size: 16px;
    }
    .scratchTop .inv{
      font-weight: 800;
      font-size: 13px;
      color: var(--muted);
    }

    .scratchStage{
      position:relative;
      height: 250px;
      background: radial-gradient(1200px 500px at 20% 20%, rgba(31,134,168,.12), transparent 60%),
                  radial-gradient(1200px 500px at 80% 40%, rgba(44,159,190,.14), transparent 60%),
                  #fff;
      z-index: 1;
    }

    .prizeLayer{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      text-align:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.8);
      font-weight: 900;
      letter-spacing: .02em;
    }
    .prizeMain{
      margin-top: 14px;
      font-size: 44px;
      line-height: 1.05;
      font-weight: 1000;
      letter-spacing: -.03em;
    }
    .prizeCode{
      margin-top: 10px;
      font-weight: 900;
      color: var(--ink);
      opacity: .9;
    }
    .prizeHint{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }

    canvas#scratchCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      touch-action: none;
      cursor: pointer;
      z-index: 5;
      background: transparent;
    }

    /* Bottom buttons */
    .bottomRow{
      display:flex;
      justify-content:flex-end;
      gap: 12px;
      padding: 14px;
      border-top: 1px dashed var(--line);
      background:#fff;
      position: relative;
      z-index: 50;
    }

    /* Confetti */
    .confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
      z-index: 9999;
    }
    .confetti i{
      position:absolute;
      top:-20px;
      width: 10px;
      height: 16px;
      opacity: .95;
      transform: rotate(0deg);
      border-radius: 2px;
      animation: fall 1100ms linear forwards;
    }
    @keyframes fall{
      to{
        transform: translate3d(var(--dx), 110vh, 0) rotate(720deg);
        opacity: 1;
      }
    }

    @media (max-width: 760px){
      .grid{grid-template-columns:1fr}
      .heroLeft h1{font-size: 34px}
      .logoBox{width:56px;height:56px}
      .logoBox img{width:48px;height:48px}
      .scratchStage{height: 280px}
      .prizeMain{font-size: 38px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hero">
        <div class="heroLeft">
          <h1>Scratch to Win</h1>
          <div class="sub">AOA Optometry’s Meeting • Phoenix 2026</div>
        </div>

        <!-- Logos (per your requested snippet) -->
        <div class="logoRow">
          <div class="logoBox"><img src="assets/aoa-logo.jpeg" alt="AOA Logo"></div>
          <div class="logoBox"><img src="assets/odgo-logo.jpeg" alt="OD on the GO Logo"></div>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div>
            <label for="name">Full Name</label>
            <input id="name" type="text" placeholder="Full name" autocomplete="name" />
          </div>
          <div>
            <label for="email">Email Address</label>
            <input id="email" type="email" placeholder="name@email.com" autocomplete="email" />
          </div>
        </div>

        <div class="rowBtns">
          <button id="saveBtn" class="primary">Save — scratch below!</button>
          <button id="nextBtn" class="ghost" disabled>Next Student</button>
        </div>

        <div id="status" class="status">
          Saved
          <span id="statusDetail" class="small"></span>
        </div>

        <div class="scratchCard">
          <div class="scratchTop">
            <div class="title">Scratch here to start</div>
            <div class="inv">Inventory remaining: <span id="invCount">—</span></div>
          </div>

          <div class="scratchStage">
            <div class="prizeLayer">
              <div>
                <div class="pill">YOUR PRIZE</div>
                <div id="prizeText" class="prizeMain">—</div>
                <div id="codeText" class="prizeCode">Code: —</div>
                <div class="prizeHint">Scratch the gray card to reveal your prize.</div>
              </div>
            </div>

            <canvas id="scratchCanvas"></canvas>
          </div>

          <!-- Buttons moved to bottom so they don’t get tapped accidentally -->
          <div class="bottomRow">
            <button id="exportBtn" class="ghost">Export CSV</button>
            <button id="resetBtn" class="ghost">Reset Device Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script>
    /***********************
     * Inventory + Storage *
     ***********************/
    const STORAGE_KEY = "odgo_scratch_state_v6";

    // Your requested inventory:
    // 2 free Part 1, 2 free Part 2, 2 free Part 3, 50 x $50 off (same code), 400 x 20% off (same code)
    // Temporary codes included — replace later.
    const TEMP_CODES = {
      off20: "ODGO20",
      off50: "ODGO50",
      freeP1: ["FREEP1-A", "FREEP1-B"],
      freeP2: ["FREEP2-A", "FREEP2-B"],
      freeP3: ["FREEP3-A", "FREEP3-B"],
    };

    function buildInitialInventory(){
      const inv = [];

      // Free programs (unique codes)
      TEMP_CODES.freeP1.forEach(code => inv.push({ prize:"FREE PART 1 COURSE", code, isFree:true }));
      TEMP_CODES.freeP2.forEach(code => inv.push({ prize:"FREE PART 2 COURSE", code, isFree:true }));
      TEMP_CODES.freeP3.forEach(code => inv.push({ prize:"FREE PART 3 COURSE", code, isFree:true }));

      // $50 off any course (50)
      for(let i=0;i<50;i++){
        inv.push({ prize:"$50 OFF ANY COURSE", code:TEMP_CODES.off50, isFree:false });
      }

      // 20% off any course (400)
      for(let i=0;i<400;i++){
        inv.push({ prize:"20% OFF ANY COURSE", code:TEMP_CODES.off20, isFree:false });
      }

      // Shuffle for true randomness
      return shuffle(inv);
    }

    function defaultState(){
      return {
        inventory: buildInitialInventory(),
        leads: [] // {name,email,prize,code,timestamp}
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);
        // Basic validation
        if(!parsed.inventory || !Array.isArray(parsed.inventory)) return defaultState();
        if(!parsed.leads || !Array.isArray(parsed.leads)) parsed.leads = [];
        return parsed;
      }catch(e){
        return defaultState();
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      invCount.textContent = state.inventory.length;
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    /***********************
     * DOM
     ***********************/
    const nameEl = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const saveBtn = document.getElementById("saveBtn");
    const nextBtn = document.getElementById("nextBtn");
    const exportBtn = document.getElementById("exportBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusBox = document.getElementById("status");
    const statusDetail = document.getElementById("statusDetail");

    const prizeText = document.getElementById("prizeText");
    const codeText = document.getElementById("codeText");
    const invCount = document.getElementById("invCount");

    const canvas = document.getElementById("scratchCanvas");
    const ctx = canvas.getContext("2d");
    const confettiLayer = document.getElementById("confetti");

    let state = loadState();
    invCount.textContent = state.inventory.length;

    // Session variables
    let currentPrize = null;
    let savedLead = null;
    let scratchEnabled = false;
    let revealed = false;

    /***********************
     * Scratch setup
     ***********************/
    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      drawCover();
    }

    function drawCover(){
      // Gray scratch cover
      const rect = canvas.getBoundingClientRect();
      ctx.globalCompositeOperation = "source-over";
      ctx.clearRect(0,0,rect.width,rect.height);
      ctx.fillStyle = "#bdbdbd";
      ctx.fillRect(0,0,rect.width,rect.height);

      // Big "SCRATCH HERE"
      ctx.fillStyle = "rgba(0,0,0,.22)";
      ctx.font = "900 40px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("SCRATCH HERE", rect.width/2, rect.height/2);
    }

    function getPoint(evt){
      const rect = canvas.getBoundingClientRect();
      const e = evt.touches ? evt.touches[0] : evt;
      return {
        x: (e.clientX - rect.left),
        y: (e.clientY - rect.top)
      };
    }

    function scratchDot(p){
      const r = 22; // brush radius
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fill();
    }

    function scratchLine(p1, p2){
      const r = 22;
      ctx.globalCompositeOperation = "destination-out";
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.lineWidth = r*2;
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();
    }

    let isDown = false;
    let last = null;

    function onDown(e){
      if(!scratchEnabled) return;

      // ✅ Make Next Student work immediately on first scratch action
      if(nextBtn.disabled) nextBtn.disabled = false;

      isDown = true;
      const p = getPoint(e);
      last = p;
      scratchDot(p);

      // "Reveal" logic for confetti: trigger once on first scratch
      if(!revealed){
        revealed = true;
        if(currentPrize?.isFree) burstConfetti();
      }

      e.preventDefault();
    }

    function onMove(e){
      if(!scratchEnabled || !isDown) return;
      const p = getPoint(e);
      scratchLine(last, p);
      last = p;
      e.preventDefault();
    }

    function onUp(){
      isDown = false;
      last = null;
    }

    canvas.addEventListener("mousedown", onDown);
    canvas.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);

    canvas.addEventListener("touchstart", onDown, {passive:false});
    canvas.addEventListener("touchmove", onMove, {passive:false});
    window.addEventListener("touchend", onUp);

    window.addEventListener("resize", resizeCanvas);
    setTimeout(resizeCanvas, 50);

    /***********************
     * Prize + Lead flow
     ***********************/
    function pickNextPrize(){
      if(state.inventory.length === 0){
        return { prize:"NO PRIZES LEFT", code:"—", isFree:false };
      }
      // Take from end for performance (inventory already shuffled)
      return state.inventory.pop();
    }

    function resetScratchCardToGray(){
      revealed = false;
      drawCover();
    }

    function setPrizeUI(prizeObj, preSave=false){
      // preSave: show placeholders before the user saves
      if(preSave){
        prizeText.textContent = "—";
        codeText.textContent = "Code: —";
      }else{
        prizeText.textContent = prizeObj.prize;
        codeText.textContent = "Code: " + prizeObj.code;
      }
    }

    function showStatus(name, email){
      statusBox.classList.add("ok");
      statusBox.textContent = "Saved";
      const span = document.createElement("span");
      span.className = "small";
      span.textContent = `${name} — ${email} (saved). Now scratch below to reveal your prize.`;
      statusBox.appendChild(span);
    }

    function clearStatus(){
      statusBox.classList.remove("ok");
      statusBox.innerHTML = "";
    }

    function validateEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
    }

    function startNewStudent(){
      nameEl.value = "";
      emailEl.value = "";
      nameEl.focus();

      savedLead = null;
      scratchEnabled = false;
      nextBtn.disabled = true;

      // New hidden prize is chosen on Save (not before)
      currentPrize = null;

      clearStatus();
      resetScratchCardToGray();
      setPrizeUI({}, true);

      // Update heading to "Scratch here to start"
      document.querySelector(".scratchTop .title").textContent = "Scratch here to start";
    }

    // Initial state
    startNewStudent();
    invCount.textContent = state.inventory.length;

    saveBtn.addEventListener("click", () => {
      const name = (nameEl.value || "").trim();
      const email = (emailEl.value || "").trim();

      if(!name){
        alert("Please enter a full name.");
        return;
      }
      if(!validateEmail(email)){
        alert("Please enter a valid email address.");
        return;
      }

      // Prevent double-saving same student without "Next Student"
      if(savedLead){
        alert("This student is already saved. Tap Next Student for the next entry.");
        return;
      }

      // Choose prize NOW (so it’s truly random and not previewed)
      currentPrize = pickNextPrize();
      saveState(); // inventory decremented here

      // Set prize text underneath scratch layer (reveals as scratched)
      setPrizeUI(currentPrize, false);

      // Save lead (one row per student)
      const timestamp = new Date().toISOString();
      savedLead = { name, email, prize: currentPrize.prize, code: currentPrize.code, timestamp };
      state.leads.push(savedLead);
      saveState();

      // Enable scratch
      scratchEnabled = true;

      // Update UI
      showStatus(name, email);
      document.querySelector(".scratchTop .title").textContent = "Scratch to reveal your prize";
      resetScratchCardToGray();

      // Keep Next Student disabled until they begin scratching (but we enable on first scratch)
      nextBtn.disabled = true;
    });

    nextBtn.addEventListener("click", () => {
      // Only allow after a save
      if(!savedLead){
        alert("Tap Save first to record the student, then scratch.");
        return;
      }
      startNewStudent();
    });

    /***********************
     * CSV Export
     ***********************/
    function toCSV(rows){
      const header = ["Name","Email","Prize","Code","Timestamp"];
      const esc = (v) => {
        const s = String(v ?? "");
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };
      const lines = [header.join(",")];
      for(const r of rows){
        lines.push([r.name, r.email, r.prize, r.code, r.timestamp].map(esc).join(","));
      }
      return lines.join("\n");
    }

    exportBtn.addEventListener("click", () => {
      if(!state.leads.length){
        alert("No leads yet.");
        return;
      }
      const csv = toCSV(state.leads);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "odgo_conference_leads.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    resetBtn.addEventListener("click", () => {
      const ok = confirm("Reset this device's leads + inventory? This cannot be undone.");
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
      saveState();
      invCount.textContent = state.inventory.length;
      startNewStudent();
      alert("Device data reset.");
    });

    /***********************
     * Confetti (free prizes)
     ***********************/
    function burstConfetti(){
      confettiLayer.innerHTML = "";
      const count = 90;
      const colors = ["#ffffff","#e6f7ff","#b6e8ff","#13e9fe","#1f86a8","#2c9fbe","#ffd166","#ef476f","#06d6a0"];

      for(let i=0;i<count;i++){
        const piece = document.createElement("i");
        const left = Math.random()*100;
        const dx = (Math.random()*2-1) * 40; // drift
        const delay = Math.random()*120;
        const dur = 900 + Math.random()*500;
        const w = 7 + Math.random()*8;
        const h = 10 + Math.random()*10;

        piece.style.left = left + "vw";
        piece.style.setProperty("--dx", dx + "vw");
        piece.style.animationDuration = dur + "ms";
        piece.style.animationDelay = delay + "ms";
        piece.style.width = w + "px";
        piece.style.height = h + "px";
        piece.style.background = colors[Math.floor(Math.random()*colors.length)];

        confettiLayer.appendChild(piece);
      }

      // clear after animation
      setTimeout(() => { confettiLayer.innerHTML = ""; }, 1700);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OD on the GO ‚Äî Conference Scratcher</title>

<style>
  :root{
    --bg:#fafafa;
    --card:#ffffff;
    --text:#111;
    --muted:#666;
    --line:#e9e9e9;
    --btn:#111;
    --btnText:#fff;
    --danger:#c0392b;
  }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width: 1100px; margin: 26px auto; padding: 0 14px; text-align:center; }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:18px;
    padding:22px;
    box-shadow: 0 2px 14px rgba(0,0,0,0.06);
  }
  h1{ margin:0 0 6px; font-size:28px; }
  .sub{ margin:0 0 18px; color:var(--muted); font-size:14px; }

  .formRow{
    max-width:680px;
    margin: 0 auto 16px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    text-align:left;
  }
  @media (max-width:760px){
    .formRow{ grid-template-columns: 1fr; }
  }
  label{ font-weight:900; font-size:13px; margin-bottom:6px; display:block; }
  input{
    width:100%;
    padding:14px;
    border:1px solid #ddd;
    border-radius:12px;
    font-size:16px;
    box-sizing:border-box;
  }

  .btnRow{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
  button{
    border:none;
    border-radius:12px;
    padding:12px 16px;
    font-weight:900;
    cursor:pointer;
    font-size:15px;
  }
  .primary{ background:var(--btn); color:var(--btnText); min-width:180px; }
  .ghost{ background:#fff; border:1px solid #ddd; color:#111; }
  button:disabled{ opacity:0.45; cursor:not-allowed; }

  .statusBar{
    max-width:760px;
    margin: 14px auto 10px;
    padding:12px;
    border:1px solid #dbeafe;
    background:#eff6ff;
    border-radius:14px;
    text-align:left;
    display:none;
  }
  .statusBar .big{ font-weight:900; font-size:14px; }
  .statusBar .small{ margin-top:6px; color:#333; font-size:13px; }

  /* Scratch area */
  .scratchArea{
    max-width: 920px;
    margin: 14px auto 10px;
    padding: 18px;
    border:1px solid var(--line);
    border-radius:16px;
    background:#fff;
  }

  /* Prize line should NOT reveal before scratch */
  .prizeTop{
    font-weight:900;
    font-size:22px;
    margin: 0 0 8px;
    letter-spacing:0.2px;
  }
  .prizeTop.muted{ color:#111; opacity:0.35; }

  .scratchStage{
    position:relative;
    width: min(900px, 100%);
    height: min(360px, 48vw);
    max-height: 420px;
    margin: 12px auto 0;
    border-radius:18px;
    overflow:hidden;
    border:1px solid #dcdcdc;
    background:#f7f7f7;
  }

  /* Underlay (what gets revealed) */
  .underlay{
    position:absolute; inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    padding:18px;
    text-align:center;
  }
  .underlay .won{ font-size:16px; color:#333; font-weight:900; letter-spacing:0.5px; }
  .underlay .big{ font-size:42px; font-weight:900; margin-top:8px; }
  .underlay .code{ margin-top:10px; font-size:16px; color:#222; }
  .underlay .note{ margin-top:12px; font-size:13px; color:#555; max-width:520px; }

  canvas{
    position:absolute; inset:0;
    width:100%; height:100%;
    touch-action:none;
  }

  .footerNote{ color:var(--muted); font-size:12px; margin-top:10px; }

  /* Confetti */
  .confetti{
    pointer-events:none;
    position:fixed;
    inset:0;
    overflow:hidden;
    display:none;
    z-index:9999;
  }
  .confetti span{
    position:absolute;
    top:-10px;
    width:10px; height:14px;
    opacity:0.9;
    transform: rotate(0deg);
    animation: fall 1200ms linear forwards;
  }
  @keyframes fall{
    to{
      transform: translateY(110vh) rotate(720deg);
      opacity:1;
    }
  }

  .alert{
    max-width:760px;
    margin: 12px auto 0;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid #ffd6d6;
    background: #fff3f3;
    color:#7a1f1f;
    text-align:left;
    display:none;
  }
</style>
</head>

<body>
<div class="confetti" id="confetti"></div>

<div class="wrap">
  <div class="card">
    <h1>üéâ Scratch to Win</h1>
    <div class="sub">Enter your info ‚Üí scratch to reveal your discount. (Offline demo: leads stored on this device, CSV export.)</div>

    <div class="formRow" id="leadForm">
      <div>
        <label for="name">Full Name</label>
        <input id="name" type="text" placeholder="Full Name" autocomplete="name">
      </div>
      <div>
        <label for="email">Email Address</label>
        <input id="email" type="email" placeholder="name@email.com" autocomplete="email">
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="startBtn" type="button">Start Game</button>
      <button class="ghost" id="nextBtn" type="button" disabled>Next Student</button>
      <button class="primary" id="exportBtn" type="button">Export CSV</button>
      <button class="ghost" id="resetAllBtn" type="button" title="Resets inventory + clears leads on THIS device only">Reset Device Data</button>
    </div>

    <div class="alert" id="alertBox"></div>

    <div class="statusBar" id="statusBar">
      <div class="big">Saved ‚úÖ</div>
      <div class="small" id="statusText"></div>
    </div>

    <div class="scratchArea">
      <div id="prizeTop" class="prizeTop muted">Scratch to reveal your prize</div>

      <div class="scratchStage" id="stage">
        <div class="underlay">
          <div class="won">üéÅ YOUR PRIZE</div>
          <div class="big" id="underBig">‚Äî</div>
          <div class="code" id="underCode">Code: ‚Äî</div>
          <div class="note" id="underNote">Enter your info above, then scratch the card to reveal your discount.</div>
        </div>
        <canvas id="scratchCanvas"></canvas>
      </div>

      <div class="footerNote">
        Tip: If you‚Äôre on multiple devices, each device keeps its own list + inventory (until we wire a backend).
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // -----------------------------
  // Storage keys
  // -----------------------------
  const LEADS_KEY = "odgo_leads_v2";
  const INV_KEY   = "odgo_inventory_v2";

  // -----------------------------
  // Prize inventory (EDIT CODES HERE)
  // -----------------------------
  const PRIZES_DEFAULT = [
    { type:"P1_FREE", label:"‚úÖ FREE PART 1 COURSE", code:"P1FREE-01", remaining:2, grand:true },
    { type:"P2_FREE", label:"‚úÖ FREE PART 2 COURSE", code:"P2FREE-01", remaining:2, grand:true },
    { type:"P3_FREE", label:"‚úÖ FREE PART 3 COURSE", code:"P3FREE-01", remaining:2, grand:true },

    // These two are ‚Äúsame code‚Äù prizes:
    { type:"50_OFF",  label:"$50 OFF ANY COURSE", code:"CONF50", remaining:50, grand:false },
    { type:"20_OFF",  label:"20% OFF ANY COURSE", code:"CONF20", remaining:500, grand:false },
  ];

  // If you want the 2+2+2 free prizes to each have UNIQUE codes,
  // do it like: P1FREE-01, P1FREE-02, etc. For now we‚Äôll auto-split below.

  // -----------------------------
  // Helpers: storage
  // -----------------------------
  function loadJSON(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || ""); }
    catch { return fallback; }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function validEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
  }
  function uid(){
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2));
  }

  // -----------------------------
  // Build a concrete inventory list with unique codes for the 2+2+2 prizes
  // We‚Äôll expand them into individual ‚Äútickets‚Äù.
  // -----------------------------
  function expandInventory(def){
    const tickets = [];
    for (const p of def){
      if (p.type === "P1_FREE"){
        tickets.push({ label:p.label, code:"P1FREE-01", grand:true });
        tickets.push({ label:p.label, code:"P1FREE-02", grand:true });
        continue;
      }
      if (p.type === "P2_FREE"){
        tickets.push({ label:p.label, code:"P2FREE-01", grand:true });
        tickets.push({ label:p.label, code:"P2FREE-02", grand:true });
        continue;
      }
      if (p.type === "P3_FREE"){
        tickets.push({ label:p.label, code:"P3FREE-01", grand:true });
        tickets.push({ label:p.label, code:"P3FREE-02", grand:true });
        continue;
      }
      // Bulk prizes: add N identical tickets
      for (let i=0;i<p.remaining;i++){
        tickets.push({ label:p.label, code:p.code, grand:!!p.grand });
      }
    }
    return tickets;
  }

  function getInventoryTickets(){
    const saved = loadJSON(INV_KEY, null);
    if (Array.isArray(saved) && saved.length) return saved;

    const fresh = expandInventory(PRIZES_DEFAULT);
    // Shuffle once so prizes are ‚Äúrandom‚Äù but inventory-accurate.
    for (let i=fresh.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [fresh[i], fresh[j]] = [fresh[j], fresh[i]];
    }
    saveJSON(INV_KEY, fresh);
    return fresh;
  }

  function popPrize(){
    const inv = getInventoryTickets();
    if (!inv.length){
      // fallback if you run out: keep giving 20% (or change this behavior)
      return { label:"20% OFF ANY COURSE", code:"CONF20", grand:false, exhausted:true };
    }
    const prize = prizeFromFront(inv);
    saveJSON(INV_KEY, inv);
    return prize;
  }
  function prizeFromFront(invArr){
    return invArr.shift();
  }

  // -----------------------------
  // Leads list
  // -----------------------------
  function getLeads(){
    const leads = loadJSON(LEADS_KEY, []);
    return Array.isArray(leads) ? leads : [];
  }
  function addLead(lead){
    const leads = getLeads();
    leads.unshift(lead);
    saveJSON(LEADS_KEY, leads);
  }

  // -----------------------------
  // UI elements
  // -----------------------------
  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");
  const startBtn = document.getElementById("startBtn");
  const nextBtn = document.getElementById("nextBtn");
  const exportBtn = document.getElementById("exportBtn");
  const resetAllBtn = document.getElementById("resetAllBtn");

  const statusBar = document.getElementById("statusBar");
  const statusText = document.getElementById("statusText");
  const alertBox = document.getElementById("alertBox");

  const prizeTop = document.getElementById("prizeTop");
  const underBig = document.getElementById("underBig");
  const underCode = document.getElementById("underCode");
  const underNote = document.getElementById("underNote");

  const confetti = document.getElementById("confetti");

  // Canvas
  const canvas = document.getElementById("scratchCanvas");
  const stage = document.getElementById("stage");
  const ctx = canvas.getContext("2d");

  // State
  let scratchEnabled = false;
  let isDown = false;
  let revealed = false;
  let currentLeadId = null;
  let currentPrize = null;

  // -----------------------------
  // Canvas sizing (critical on iPad/Safari)
  // -----------------------------
  function fitCanvas(){
    const r = stage.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.max(1, Math.floor(r.width * dpr));
    canvas.height = Math.max(1, Math.floor(r.height * dpr));
    canvas.style.width = r.width + "px";
    canvas.style.height = r.height + "px";
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
  }

  function drawCover(){
    const r = stage.getBoundingClientRect();
    // Draw in CSS pixels
    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0,0,r.width,r.height);

    // grey cover
    ctx.fillStyle = "#bfbfbf";
    ctx.fillRect(0,0,r.width,r.height);

    // text
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.font = "bold 34px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SCRATCH HERE", r.width/2, r.height/2);

    // erase mode
    ctx.globalCompositeOperation = "destination-out";
  }

  function pointerPos(evt){
    const rect = stage.getBoundingClientRect();
    const p = evt.touches ? evt.touches[0] : evt;
    return { x: (p.clientX - rect.left), y: (p.clientY - rect.top) };
  }

  function scratch(x,y){
    ctx.beginPath();
    ctx.arc(x,y,26,0,Math.PI*2);
    ctx.fill();
  }

  function clearedPercent(){
    // Sample down for speed
    const w = canvas.width, h = canvas.height;
    const img = ctx.getImageData(0,0,w,h).data;
    let cleared = 0;
    // alpha channel every 4th byte; sample every ~8 pixels
    const stride = 4 * 8;
    for (let i=3;i<img.length;i+=stride){
      if (img[i] === 0) cleared++;
    }
    return cleared / (img.length/stride);
  }

  function showAlert(msg){
    alertBox.textContent = msg;
    alertBox.style.display = "block";
    setTimeout(() => { alertBox.style.display="none"; }, 2600);
  }

  function setPrizeUIBeforeReveal(){
    // IMPORTANT: do NOT show prize label before scratch
    prizeTop.textContent = "Scratch to reveal your prize";
    prizeTop.classList.add("muted");
    underBig.textContent = "‚Äî";
    underCode.textContent = "Code: ‚Äî";
    underNote.textContent = "Scratch the card to reveal your discount.";
  }

  function setPrizeUIAfterReveal(prize){
    prizeTop.textContent = prize.label;
    prizeTop.classList.remove("muted");
    underBig.textContent = prize.label;
    underCode.textContent = "Code: " + prize.code;

    if (prize.label.includes("FREE")){
      underNote.textContent = "üéâ Grand prize! Please show this screen to the booth staff. We‚Äôll help you redeem it.";
    } else {
      underNote.textContent = "Show this code to the booth staff (or screenshot it).";
    }
  }

  function confettiPop(){
    confetti.innerHTML = "";
    confetti.style.display = "block";
    const colors = ["#111","#888","#f59e0b","#22c55e","#3b82f6","#ef4444","#a855f7"];
    const n = 70;

    for (let i=0;i<n;i++){
      const s = document.createElement("span");
      const left = Math.random()*100;
      const delay = Math.random()*150;
      const size = 8 + Math.random()*10;
      s.style.left = left + "vw";
      s.style.animationDelay = delay + "ms";
      s.style.width = size + "px";
      s.style.height = (size*1.2) + "px";
      s.style.background = colors[Math.floor(Math.random()*colors.length)];
      confetti.appendChild(s);
    }
    setTimeout(() => { confetti.style.display = "none"; }, 1400);
  }

  function lockLeadInputs(locked){
    nameEl.disabled = locked;
    emailEl.disabled = locked;
    startBtn.disabled = locked;
  }

  function enableScratch(enabled){
    scratchEnabled = enabled;
    nextBtn.disabled = !enabled; // allow next student only after start
  }

  function startRoundForLead(name,email){
    currentLeadId = uid();
    revealed = false;

    // Save lead now (before scratch)
    addLead({
      id: currentLeadId,
      name,
      email,
      startedAt: new Date().toISOString(),
      revealedAt: null,
      prizeLabel: null,
      prizeCode: null
    });

    // Pick prize NOW but do NOT display it until reveal
    currentPrize = popPrize();
    setPrizeUIBeforeReveal();

    // UI status
    statusText.textContent = `${name} ‚Äî ${email} (saved). Now scratch below to reveal your prize.`;
    statusBar.style.display = "block";

    // Prepare scratch
    fitCanvas();
    drawCover();
    enableScratch(true);
    lockLeadInputs(true);
    startBtn.textContent = "Saved ‚Äî scratch below!";
  }

  function updateLeadWithPrize(){
    if (!currentLeadId || !currentPrize) return;
    const leads = getLeads();
    const idx = leads.findIndex(l => l.id === currentLeadId);
    if (idx === -1) return;

    leads[idx].revealedAt = new Date().toISOString();
    leads[idx].prizeLabel = currentPrize.label;
    leads[idx].prizeCode  = currentPrize.code;
    saveJSON(LEADS_KEY, leads);
  }

  function resetForNextStudent(){
    // reset fields
    nameEl.value = "";
    emailEl.value = "";
    statusBar.style.display = "none";
    alertBox.style.display = "none";

    // reset state
    currentLeadId = null;
    currentPrize = null;
    revealed = false;
    isDown = false;

    lockLeadInputs(false);
    startBtn.textContent = "Start Game";
    enableScratch(false);

    // reset scratch surface
    setPrizeUIBeforeReveal();
    fitCanvas();
    drawCover();
  }

  // -----------------------------
  // Event wiring
  // -----------------------------
  startBtn.addEventListener("click", () => {
    const name = (nameEl.value||"").trim();
    const email = (emailEl.value||"").trim();

    if (!name) return showAlert("Please enter a full name.");
    if (!validEmail(email)) return showAlert("Please enter a valid email address.");

    startRoundForLead(name,email);
  });

  nextBtn.addEventListener("click", () => {
    resetForNextStudent();
  });

  exportBtn.addEventListener("click", () => {
    const leads = getLeads();
    if (!leads.length){
      alert("No leads yet.");
      return;
    }
    const header = "name,email,startedAt,revealedAt,prizeLabel,prizeCode\n";
    const rows = leads.map(l => {
      const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
      return [
        esc(l.name),
        esc(l.email),
        esc(l.startedAt),
        esc(l.revealedAt || ""),
        esc(l.prizeLabel || ""),
        esc(l.prizeCode || "")
      ].join(",");
    }).join("\n");

    const blob = new Blob([header + rows], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "odgo_conference_leads.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  resetAllBtn.addEventListener("click", () => {
    const ok = confirm("Reset inventory + clear ALL saved leads on THIS device?");
    if (!ok) return;
    localStorage.removeItem(LEADS_KEY);
    localStorage.removeItem(INV_KEY);
    alert("Device data cleared.");
    resetForNextStudent();
  });

  // Scratch events
  function onDown(e){
    if (!scratchEnabled) return;
    isDown = true;
    const p = pointerPos(e);
    scratch(p.x, p.y);
    checkReveal();
    e.preventDefault?.();
  }
  function onMove(e){
    if (!scratchEnabled || !isDown) return;
    const p = pointerPos(e);
    scratch(p.x, p.y);
    checkReveal();
    e.preventDefault?.();
  }
  function onUp(){
    isDown = false;
  }

  function checkReveal(){
    if (revealed) return;
    // threshold tuned so it doesn't require full erase
    const pct = clearedPercent();
    if (pct >= 0.55){
      revealed = true;

      // Reveal prize to UI now
      setPrizeUIAfterReveal(currentPrize);
      updateLeadWithPrize();

      // Grand prize effect
      if (currentPrize && currentPrize.grand){
        confettiPop();
      }
    }
  }

  stage.addEventListener("mousedown", onDown);
  stage.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);

  stage.addEventListener("touchstart", onDown, { passive:false });
  stage.addEventListener("touchmove", onMove, { passive:false });
  stage.addEventListener("touchend", onUp);

  window.addEventListener("resize", () => {
    // keep scratch layer aligned
    fitCanvas();
    // If mid-round, redraw cover only if not revealed yet
    if (!revealed) drawCover();
  });

  // Init
  setPrizeUIBeforeReveal();
  fitCanvas();
  drawCover();
  enableScratch(false);
});
</script>
</body>
</html>

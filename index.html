<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OD on the GO ‚Äî Conference Scratcher</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --line:#e8e8ee;
      --btn:#111;
      --btnText:#fff;
      --soft:#f1f6ff;
      --softLine:#cfe2ff;
      --ok:#0a7a2a;
    }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 26px auto;
      padding: 0 14px;
      text-align:center;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 22px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.06);
    }
    h1{ margin: 0 0 6px; font-size: 30px; }
    .subtitle{
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 13px;
    }

    .leadRow{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      max-width: 760px;
      margin: 0 auto 12px;
      text-align:left;
    }
    .field label{
      display:block;
      font-weight: 900;
      font-size: 13px;
      margin: 0 0 8px;
    }
    .field input{
      width:100%;
      box-sizing: border-box;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      font-size: 16px;
      outline: none;
    }
    .field input:disabled{
      background:#fafafa;
      color:#999;
    }

    .btnRow{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap: wrap;
      margin: 12px 0 14px;
    }
    .btn{
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 900;
      cursor: pointer;
      font-size: 15px;
    }
    .btn.primary{
      background: var(--btn);
      color: var(--btnText);
      min-width: 210px;
    }
    .btn.ghost{
      background:#fff;
      color:#111;
      border:1px solid var(--line);
      min-width: 160px;
    }
    .btn:disabled{ opacity: .45; cursor:not-allowed; }

    .savedBanner{
      display:none;
      max-width: 760px;
      margin: 0 auto 16px;
      text-align:left;
      padding: 12px 14px;
      background: var(--soft);
      border: 1px solid var(--softLine);
      border-radius: 14px;
      font-size: 14px;
    }
    .savedBanner .title{
      font-weight: 900;
      margin-bottom: 4px;
      color: var(--ok);
    }

    .prizeWrap{
      max-width: 820px;
      margin: 0 auto;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
    }
    .prizeTop{
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items:center;
      justify-content:center;
      margin-bottom: 10px;
    }
    .prizeTop .hint{
      font-size: 12px;
      color: var(--muted);
    }

    .prizeCard{
      position: relative;
      width: 100%;
      max-width: 820px;
      margin: 0 auto;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--line);
      background: #fff;
      height: 320px;
    }

    .underlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      text-align:center;
    }
    .underlayInner{
      max-width: 520px;
      margin: 0 auto;
    }
    .preReveal .big{
      font-size: 22px;
      font-weight: 900;
      margin-top: 10px;
    }
    .preReveal .small{
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }

    .postReveal{
      display:none;
      animation: pop 240ms ease-out;
    }
    @keyframes pop{
      from { transform: scale(0.98); opacity: 0.1; }
      to   { transform: scale(1); opacity: 1; }
    }
    .postReveal .emoji{
      font-size: 34px;
      line-height: 1;
    }
    .postReveal .label{
      font-size: 30px;
      font-weight: 900;
      margin-top: 8px;
    }
    .postReveal .code{
      margin-top: 10px;
      font-size: 15px;
      color:#333;
      font-weight: 900;
    }
    .postReveal .note{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    canvas#scratchCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      touch-action: none;
      cursor: crosshair;
    }

    .footNote{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 720px){
      .leadRow{ grid-template-columns: 1fr; }
      .prizeCard{ height: 280px; }
      .postReveal .label{ font-size: 26px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üéâ Scratch to Win</h1>
      <div class="subtitle">
        Enter your info ‚Üí scratch to reveal your discount.
        (Offline demo: leads + prizes stored on this device, export CSV.)
      </div>

      <div class="leadRow">
        <div class="field">
          <label for="fullName">Full Name</label>
          <input id="fullName" type="text" placeholder="Full name" autocomplete="name">
        </div>
        <div class="field">
          <label for="email">Email Address</label>
          <input id="email" type="email" placeholder="name@email.com" autocomplete="email">
        </div>
      </div>

      <div class="btnRow">
        <button id="saveBtn" class="btn primary" type="button">Save ‚Äî scratch below!</button>
        <button id="nextBtn" class="btn ghost" type="button" disabled>Next Student</button>
        <button id="exportBtn" class="btn primary" type="button">Export CSV</button>
        <button id="resetBtn" class="btn ghost" type="button">Reset Device Data</button>
      </div>

      <div id="savedBanner" class="savedBanner">
        <div class="title">Saved ‚úÖ</div>
        <div id="savedText">‚Äî</div>
      </div>

      <div class="prizeWrap">
        <div class="prizeTop">
          <div style="font-weight:900;">Scratch to reveal your prize</div>
          <div id="invText" class="hint">Inventory remaining: ‚Äî</div>
        </div>

        <div class="prizeCard">
          <div class="underlay" aria-live="polite">
            <div class="underlayInner">
              <div id="preReveal" class="preReveal">
                <div style="font-size:28px;">ü™ô</div>
                <div class="big">Scratch the gray card</div>
                <div class="small">Your prize will appear when enough is scratched.</div>
              </div>

              <div id="postReveal" class="postReveal">
                <div class="emoji">üéÅ</div>
                <div style="font-size:12px; letter-spacing:1px; color:#444; font-weight:900; margin-top:8px;">YOUR PRIZE</div>
                <div id="prizeLabel" class="label">‚Äî</div>
                <div id="prizeCode" class="code">Code: ‚Äî</div>
                <div class="note">Take a screenshot if you want ‚Äî your email is saved in the CSV export.</div>
              </div>
            </div>
          </div>

          <canvas id="scratchCanvas"></canvas>
        </div>

        <div class="footNote">
          Tip: If you use multiple devices, each device keeps its own lead list + prize inventory (until we wire a backend).
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Storage keys =====
  const KEY_LEADS = "odgo_scratcher_leads_v3";
  const KEY_INV   = "odgo_scratcher_inventory_v3";

  // ===== Temporary inventory (replace codes later) =====
  function defaultInventory(){
    const inv = [];
    // 2 free Part 1 (unique)
    inv.push({type:"FREE_PART1", label:"üéì FREE Part 1 Course", code:"TEMP-P1-001"});
    inv.push({type:"FREE_PART1", label:"üéì FREE Part 1 Course", code:"TEMP-P1-002"});
    // 2 free Part 2 (unique)
    inv.push({type:"FREE_PART2", label:"üéì FREE Part 2 Course", code:"TEMP-P2-001"});
    inv.push({type:"FREE_PART2", label:"üéì FREE Part 2 Course", code:"TEMP-P2-002"});
    // 2 free Part 3 (unique)
    inv.push({type:"FREE_PART3", label:"üéì FREE Part 3 Course", code:"TEMP-P3-001"});
    inv.push({type:"FREE_PART3", label:"üéì FREE Part 3 Course", code:"TEMP-P3-002"});
    // 50 x $50 off (same code)
    for(let i=0;i<50;i++) inv.push({type:"50_OFF", label:"üíµ $50 OFF any course", code:"TEMP-50OFF"});
    // 500 x 20% off (same code)
    for(let i=0;i<500;i++) inv.push({type:"20_OFF", label:"üî• 20% OFF any course", code:"TEMP-20OFF"});
    return inv;
  }

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  function validEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
  }
  function uuid(){
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
  }

  function loadLeads(){
    try { return JSON.parse(localStorage.getItem(KEY_LEADS) || "[]"); }
    catch { return []; }
  }
  function saveLeads(leads){
    localStorage.setItem(KEY_LEADS, JSON.stringify(leads));
  }

  function loadInv(){
    try {
      const raw = localStorage.getItem(KEY_INV);
      if (!raw) return defaultInventory();
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || parsed.length === 0) return defaultInventory();
      return parsed;
    } catch {
      return defaultInventory();
    }
  }
  function saveInv(inv){
    localStorage.setItem(KEY_INV, JSON.stringify(inv));
  }
  function invCount(){
    return loadInv().length;
  }
  function updateInvText(){
    $("invText").textContent = "Inventory remaining: " + invCount();
  }

  function drawPrize(){
    const inv = loadInv();
    if (!inv.length){
      return {type:"FALLBACK", label:"üî• 20% OFF any course", code:"TEMP-20OFF"};
    }
    const idx = Math.floor(Math.random() * inv.length);
    const prize = inv.splice(idx, 1)[0];
    saveInv(inv);
    updateInvText();
    return prize;
  }

  // ===== UI state =====
  let currentLeadId = null;
  let currentPrize = null;
  let revealed = false;

  function lockForm(lock){
    $("fullName").disabled = lock;
    $("email").disabled = lock;
    $("saveBtn").disabled = lock;
    $("nextBtn").disabled = !lock;
  }

  function showSavedBanner(name, email){
    $("savedText").textContent = `${name} ‚Äî ${email} (saved). Now scratch below to reveal your prize.`;
    $("savedBanner").style.display = "block";
  }
  function hideSavedBanner(){
    $("savedBanner").style.display = "none";
  }

  function showPreReveal(){
    $("preReveal").style.display = "block";
    $("postReveal").style.display = "none";
    $("prizeLabel").textContent = "‚Äî";
    $("prizeCode").textContent = "Code: ‚Äî";
    revealed = false;
  }
  function showPostReveal(prize){
    $("prizeLabel").textContent = prize.label;
    $("prizeCode").textContent  = "Code: " + prize.code;
    $("preReveal").style.display = "none";
    $("postReveal").style.display = "block";
    revealed = true;
  }

  // ===== Scratch canvas =====
  const canvas = $("scratchCanvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });
  let isDown = false;

  function sizeCanvasToBox(){
    const box = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.max(1, Math.round(box.width * dpr));
    canvas.height = Math.max(1, Math.round(box.height * dpr));
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function drawCover(){
    const box = canvas.getBoundingClientRect();
    const w = box.width;
    const h = box.height;

    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0,0,w,h);

    // solid cover
    ctx.fillStyle = "#bdbdbd";
    ctx.fillRect(0,0,w,h);

    // text
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.font = "900 28px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SCRATCH HERE", w/2, h/2);

    // erase mode
    ctx.globalCompositeOperation = "destination-out";
  }

  function getPos(evt){
    const r = canvas.getBoundingClientRect();
    const t = evt.touches ? evt.touches[0] : evt;
    return { x: t.clientX - r.left, y: t.clientY - r.top };
  }

  function scratchAt(x,y){
    ctx.beginPath();
    ctx.arc(x,y,22,0,Math.PI*2);
    ctx.fill();
  }

  // sample-based completion (fast on iPad)
  function clearedFraction(){
    const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    const step = Math.max(10, Math.floor((canvas.width + canvas.height) / 900));
    let total=0, cleared=0;
    for (let y=0; y<canvas.height; y+=step){
      for (let x=0; x<canvas.width; x+=step){
        const i = (y*canvas.width + x)*4 + 3; // alpha
        total++;
        if (data[i] === 0) cleared++;
      }
    }
    return cleared/total;
  }

  function updateLeadAfterReveal(){
    if (!currentLeadId || !currentPrize) return;
    const leads = loadLeads();
    const idx = leads.findIndex(l => l.id === currentLeadId);
    if (idx === -1) return;

    leads[idx].revealedAt = new Date().toISOString();
    leads[idx].prizeType  = currentPrize.type;
    leads[idx].prizeLabel = currentPrize.label;
    leads[idx].prizeCode  = currentPrize.code;
    saveLeads(leads);
  }

  function checkComplete(){
    if (revealed) return;
    // slightly easier threshold so it reveals sooner on iPad
    const pct = clearedFraction();
    if (pct >= 0.40){
      showPostReveal(currentPrize);
      updateLeadAfterReveal();
    }
  }

  function onDown(e){
    if (!currentLeadId) return; // must Save first
    isDown = true;
    const p = getPos(e);
    scratchAt(p.x,p.y);
    checkComplete();
    e.preventDefault?.();
  }
  function onMove(e){
    if (!isDown) return;
    if (!currentLeadId) return;
    const p = getPos(e);
    scratchAt(p.x,p.y);
    checkComplete();
    e.preventDefault?.();
  }
  function onUp(){ isDown = false; }

  canvas.addEventListener("mousedown", onDown);
  canvas.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);

  canvas.addEventListener("touchstart", onDown, { passive:false });
  canvas.addEventListener("touchmove", onMove, { passive:false });
  canvas.addEventListener("touchend", onUp);

  // ===== Workflow =====
  function startRoundAfterSave(name, email){
    currentPrize = drawPrize(); // reserve prize from inventory now
    currentLeadId = uuid();

    const leads = loadLeads();
    leads.unshift({
      id: currentLeadId,
      name,
      email,
      startedAt: new Date().toISOString(),
      revealedAt: null,
      prizeType: null,
      prizeLabel: null,
      prizeCode: null
    });
    saveLeads(leads);

    lockForm(true);
    showSavedBanner(name, email);

    showPreReveal();
    sizeCanvasToBox();
    drawCover();
  }

  function resetForNextStudent(){
    currentLeadId = null;
    currentPrize = null;
    revealed = false;
    isDown = false;

    $("fullName").value = "";
    $("email").value = "";
    lockForm(false);
    hideSavedBanner();

    showPreReveal();
    sizeCanvasToBox();
    drawCover();
  }

  $("saveBtn").addEventListener("click", () => {
    const name  = ($("fullName").value || "").trim();
    const email = ($("email").value || "").trim();

    if (!name){ alert("Please enter a full name."); return; }
    if (!validEmail(email)){ alert("Please enter a valid email address."); return; }

    startRoundAfterSave(name, email);
  });

  $("nextBtn").addEventListener("click", () => {
    resetForNextStudent();
  });

  $("exportBtn").addEventListener("click", () => {
    const leads = loadLeads();
    if (!leads.length){
      alert("No leads yet.");
      return;
    }

    const header = "name,email,startedAt,revealedAt,prizeType,prizeLabel,prizeCode\n";
    const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;

    const rows = leads.map(l => ([
      esc(l.name),
      esc(l.email),
      esc(l.startedAt),
      esc(l.revealedAt || ""),
      esc(l.prizeType || ""),
      esc(l.prizeLabel || ""),
      esc(l.prizeCode || "")
    ].join(","))).join("\n");

    const blob = new Blob([header + rows], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "odgo_scratcher_leads.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("resetBtn").addEventListener("click", () => {
    if (!confirm("Reset device data? This clears saved leads AND resets prize inventory on this device.")) return;
    localStorage.removeItem(KEY_LEADS);
    localStorage.removeItem(KEY_INV);
    alert("Device data cleared.");

    saveInv(defaultInventory());
    updateInvText();
    resetForNextStudent();
  });

  window.addEventListener("resize", () => {
    sizeCanvasToBox();
    drawCover();
  });

  // ===== Init =====
  if (!localStorage.getItem(KEY_INV)){
    saveInv(defaultInventory());
  }
  updateInvText();
  showPreReveal();
  sizeCanvasToBox();
  drawCover();
  lockForm(false);

})();
</script>
</body>
</html>

<script>
const STORAGE_KEY = "odgo_leads_v2";

/* ===== STORAGE ===== */

function getLeads(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}
function setLeads(data){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* ===== PRIZE POOL ===== */

function buildPrizePool(){
  let pool = [];

  pool.push({label:"FREE PART 1 COURSE", code:"P1_CODE_1", grand:true});
  pool.push({label:"FREE PART 1 COURSE", code:"P1_CODE_2", grand:true});
  pool.push({label:"FREE PART 2 COURSE", code:"P2_CODE_1", grand:true});
  pool.push({label:"FREE PART 2 COURSE", code:"P2_CODE_2", grand:true});
  pool.push({label:"FREE PART 3 COURSE", code:"P3_CODE_1", grand:true});
  pool.push({label:"FREE PART 3 COURSE", code:"P3_CODE_2", grand:true});

  for(let i=0;i<50;i++){
    pool.push({label:"$50 OFF ANY COURSE", code:"CONF50", grand:false});
  }

  for(let i=0;i<500;i++){
    pool.push({label:"20% OFF ANY COURSE", code:"CONF20", grand:false});
  }

  for(let i=pool.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [pool[i],pool[j]]=[pool[j],pool[i]];
  }

  return pool;
}

let prizePool = buildPrizePool();
let currentPrize = null;
let currentLead = null;

/* ===== SCRATCH ===== */

const canvas = document.getElementById("scratchCanvas");
const ctx = canvas.getContext("2d");

function drawCover(){
  ctx.globalCompositeOperation="source-over";
  ctx.fillStyle="#bfbfbf";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="rgba(0,0,0,.4)";
  ctx.font="bold 24px Arial";
  ctx.textAlign="center";
  ctx.fillText("SCRATCH HERE",canvas.width/2,canvas.height/2);
  ctx.globalCompositeOperation="destination-out";
}

function scratch(x,y){
  ctx.beginPath();
  ctx.arc(x,y,25,0,Math.PI*2);
  ctx.fill();
}

function getPos(e){
  const r=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return {
    x:(t.clientX-r.left)*(canvas.width/r.width),
    y:(t.clientY-r.top)*(canvas.height/r.height)
  };
}

function percentCleared(){
  const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let cleared = 0;
  for(let i=3;i<pixels.length;i+=4){
    if(pixels[i]===0) cleared++;
  }
  return cleared/(pixels.length/4);
}

let scratching=false;
let revealed=false;

canvas.addEventListener("mousedown",e=>{
  scratching=true;
  const p=getPos(e);
  scratch(p.x,p.y);
  checkReveal();
});
canvas.addEventListener("mousemove",e=>{
  if(!scratching) return;
  const p=getPos(e);
  scratch(p.x,p.y);
  checkReveal();
});
window.addEventListener("mouseup",()=>scratching=false);

canvas.addEventListener("touchstart",e=>{
  scratching=true;
  const p=getPos(e);
  scratch(p.x,p.y);
  checkReveal();
  e.preventDefault();
},{passive:false});
canvas.addEventListener("touchmove",e=>{
  if(!scratching) return;
  const p=getPos(e);
  scratch(p.x,p.y);
  checkReveal();
  e.preventDefault();
},{passive:false});
canvas.addEventListener("touchend",()=>scratching=false);

function checkReveal(){
  if(revealed) return;
  if(percentCleared() > 0.45){
    revealed=true;

    document.getElementById("prizeLabel").textContent=currentPrize.label;
    document.getElementById("resetBtn").disabled=false;

    saveLead();
  }
}

/* ===== FLOW ===== */

document.getElementById("startBtn").addEventListener("click",()=>{
  const name=document.getElementById("name").value.trim();
  const email=document.getElementById("email").value.trim();

  if(!name || !email){
    alert("Enter name + email");
    return;
  }

  if(prizePool.length===0){
    alert("All prizes claimed.");
    return;
  }

  currentPrize = prizePool.pop();
  currentLead = {name,email};

  document.getElementById("leadGate").style.display="none";
  document.getElementById("gameArea").style.display="block";
  document.getElementById("prizeLabel").textContent="";

  revealed=false;
  drawCover();
});

/* ===== SAVE ===== */

function saveLead(){
  const leads=getLeads();
  leads.push({
    name:currentLead.name,
    email:currentLead.email,
    prize:currentPrize.label,
    code:currentPrize.code,
    time:new Date().toISOString()
  });
  setLeads(leads);
}

/* ===== RESET ===== */

document.getElementById("resetBtn").addEventListener("click",()=>{
  document.getElementById("name").value="";
  document.getElementById("email").value="";
  document.getElementById("leadGate").style.display="block";
  document.getElementById("gameArea").style.display="none";
  document.getElementById("resetBtn").disabled=true;
});

/* ===== EXPORT ===== */

document.getElementById("exportBtn").addEventListener("click",()=>{
  const leads=getLeads();
  if(!leads.length){
    alert("No leads yet.");
    return;
  }

  const header="name,email,prize,code,time\n";
  const rows=leads.map(l=>`${l.name},${l.email},${l.prize},${l.code},${l.time}`).join("\n");

  const blob=new Blob([header+rows],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="odgo_leads.csv";
  a.click();
  URL.revokeObjectURL(url);
});

drawCover();
</script>

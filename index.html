<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OD on the GO ‚Äî Conference Scratcher</title>

<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --btn:#111;
    --btnText:#fff;
    --okBg:#eef6ff;
    --okLine:#c7ddff;
  }

  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width:1100px; margin:26px auto; padding:0 14px; text-align:center; }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
    padding:22px;
  }

  h1{ margin:0 0 6px; font-size:40px; letter-spacing:-0.02em; }
  .sub{ margin:0 0 18px; color:var(--muted); }

  .formRow{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
    max-width:780px;
    margin: 0 auto 14px;
    text-align:left;
  }
  @media (max-width: 760px){
    .formRow{ grid-template-columns:1fr; }
    h1{ font-size:34px; }
  }

  label{ font-weight:900; font-size:14px; margin-bottom:6px; display:block; }
  input{
    width:100%;
    padding:14px 14px;
    border:1px solid var(--line);
    border-radius:14px;
    font-size:16px;
    box-sizing:border-box;
    outline:none;
    background:#fff;
  }

  .btnRow{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:12px;
    margin: 10px 0 14px;
  }

  button{
    border:none;
    border-radius:14px;
    padding:14px 18px;
    font-weight:900;
    font-size:15px;
    cursor:pointer;
  }
  .primary{
    background:var(--btn);
    color:var(--btnText);
    min-width:220px;
  }
  .ghost{
    background:#fff;
    border:1px solid var(--line);
    color:#111;
    min-width:170px;
  }
  button:disabled{ opacity:0.55; cursor:not-allowed; }

  .savedBox{
    max-width:780px;
    margin: 0 auto 16px;
    text-align:left;
    background:var(--okBg);
    border:1px solid var(--okLine);
    border-radius:16px;
    padding:14px 14px;
    display:none;
  }
  .savedBox b{ display:block; margin-bottom:6px; }
  .savedBox .small{ color:#334155; font-size:14px; }

  .scratchWrap{
    max-width:880px;
    margin: 0 auto;
    border:1px solid var(--line);
    border-radius:20px;
    overflow:hidden;
    background:#fff;
  }

  .scratchHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    text-align:left;
  }
  .scratchHeader .title{ font-weight:900; }
  .scratchHeader .inv{ color:var(--muted); font-size:13px; }

  .stage{
    position:relative;
    width:100%;
    aspect-ratio: 16 / 7;
    min-height: 260px;
    background: radial-gradient(circle at 20% 35%, rgba(99,102,241,0.14), transparent 45%),
                radial-gradient(circle at 75% 40%, rgba(16,185,129,0.12), transparent 45%),
                radial-gradient(circle at 50% 80%, rgba(245,158,11,0.12), transparent 45%),
                #ffffff;
  }
  @media (max-width: 760px){
    .stage{ aspect-ratio: 16 / 10; }
  }

  /* Underlay (what they will reveal) */
  .underlay{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:18px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 14px;
    border:1px solid var(--line);
    border-radius:999px;
    background:#fff;
    font-weight:900;
    margin-bottom:14px;
  }
  .prizeBig{
    font-size:44px;
    font-weight:900;
    letter-spacing:-0.02em;
    margin:0 0 8px;
  }
  .codeLine{
    font-size:18px;
    color:#111;
    margin:0 0 8px;
  }
  .hint{ color:var(--muted); font-size:14px; margin:0; }

  /* Canvas (scratch layer) */
  canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    z-index:5;
    touch-action:none;
  }

  .footerNote{
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üéâ Scratch to Win</h1>
      <div class="sub">Enter your info ‚Üí tap <b>Save</b> ‚Üí scratch the gray card to reveal your prize. (Offline demo: stored on this device; export CSV.)</div>

      <div class="formRow">
        <div>
          <label for="name">Full Name</label>
          <input id="name" autocomplete="name" placeholder="Full name" />
        </div>
        <div>
          <label for="email">Email Address</label>
          <input id="email" autocomplete="email" placeholder="name@email.com" />
        </div>
      </div>

      <div class="btnRow">
        <button id="saveBtn" class="primary" type="button">Save ‚Äî scratch below!</button>
        <button id="nextBtn" class="ghost" type="button" disabled>Next Student</button>
        <button id="exportBtn" class="primary" type="button" style="min-width:190px;">Export CSV</button>
        <button id="resetBtn" class="ghost" type="button" style="min-width:190px;">Reset Device Data</button>
      </div>

      <div id="savedBox" class="savedBox">
        <b>Saved ‚úÖ</b>
        <div class="small" id="savedText"></div>
      </div>

      <div class="scratchWrap">
        <div class="scratchHeader">
          <div class="title">Scratch to reveal your prize</div>
          <div class="inv">Inventory remaining: <span id="invCount">‚Äî</span></div>
        </div>

        <div class="stage" id="stage">
          <!-- Underlay content (hidden until scratched, but we keep placeholder text until reveal) -->
          <div class="underlay">
            <div>
              <div class="pill">üéÅ YOUR PRIZE</div>
              <div class="prizeBig" id="prizeLabel">‚Äî</div>
              <div class="codeLine" id="prizeCode">Code: ‚Äî</div>
              <p class="hint" id="hintText">Scratch the gray card to reveal your discount.</p>
            </div>
          </div>

          <!-- Scratch layer -->
          <canvas id="scratch"></canvas>
        </div>
      </div>

      <div class="footerNote">Tip: Each device keeps its own leads + inventory (until you connect a backend). For now, export CSV from each device.</div>
    </div>
  </div>

<script>
(() => {
  // ============================
  // LocalStorage keys
  // ============================
  const LEADS_KEY = "odgo_leads_v1";
  const INV_KEY   = "odgo_inventory_v1";

  // ============================
  // Prize inventory (TEMP CODES)
  // Replace later with your real codes.
  // ============================
  function defaultInventory(){
    // 6 grand prizes (unique)
    const inv = [
      { type:"GRAND", label:"FREE PART 1 COURSE", code:"P1FREE-A", remaining:1 },
      { type:"GRAND", label:"FREE PART 1 COURSE", code:"P1FREE-B", remaining:1 },
      { type:"GRAND", label:"FREE PART 2 COURSE", code:"P2FREE-A", remaining:1 },
      { type:"GRAND", label:"FREE PART 2 COURSE", code:"P2FREE-B", remaining:1 },
      { type:"GRAND", label:"FREE PART 3 COURSE", code:"P3FREE-A", remaining:1 },
      { type:"GRAND", label:"FREE PART 3 COURSE", code:"P3FREE-B", remaining:1 },

      // 50 x $50 off (same code)
      { type:"50OFF", label:"$50 OFF ANY COURSE", code:"ODGO50", remaining:50 },

      // 500 x 20% off (same code)
      { type:"20OFF", label:"20% OFF ANY COURSE", code:"ODGO20", remaining:500 }
    ];
    return inv;
  }

  function loadInventory(){
    try{
      const raw = localStorage.getItem(INV_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed)) return null;
      return parsed;
    }catch{ return null; }
  }
  function saveInventory(inv){
    localStorage.setItem(INV_KEY, JSON.stringify(inv));
  }
  function ensureInventory(){
    let inv = loadInventory();
    if(!inv){
      inv = defaultInventory();
      saveInventory(inv);
    }
    return inv;
  }
  function inventoryRemaining(inv){
    return inv.reduce((sum, item) => sum + (Number(item.remaining)||0), 0);
  }

  // Pick prize with correct weighting:
  // - Grand prizes are rare (6 total)
  // - Then $50 off (50)
  // - Then 20% off (500)
  // This selection is proportional to remaining counts.
  function pickPrize(inv){
    const pool = [];
    inv.forEach((item, idx) => {
      const n = Math.max(0, Number(item.remaining)||0);
      if(n > 0) pool.push({ idx, weight:n });
    });
    if(!pool.length) return null;

    const total = pool.reduce((s,p)=>s+p.weight,0);
    let r = Math.random() * total;
    for(const p of pool){
      r -= p.weight;
      if(r <= 0){
        // decrement inventory
        inv[p.idx].remaining -= 1;
        saveInventory(inv);
        // return a copy
        return { ...inv[p.idx] };
      }
    }
    // fallback (shouldn‚Äôt happen)
    const last = pool[pool.length-1];
    inv[last.idx].remaining -= 1;
    saveInventory(inv);
    return { ...inv[last.idx] };
  }

  // ============================
  // Leads storage
  // ============================
  function loadLeads(){
    try{
      return JSON.parse(localStorage.getItem(LEADS_KEY) || "[]");
    }catch{
      return [];
    }
  }
  function saveLeads(leads){
    localStorage.setItem(LEADS_KEY, JSON.stringify(leads));
  }
  function uid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
  }
  function validEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
  }

  // ============================
  // UI elements
  // ============================
  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");

  const saveBtn = document.getElementById("saveBtn");
  const nextBtn = document.getElementById("nextBtn");
  const exportBtn = document.getElementById("exportBtn");
  const resetBtn = document.getElementById("resetBtn");

  const savedBox = document.getElementById("savedBox");
  const savedText = document.getElementById("savedText");

  const invCount = document.getElementById("invCount");

  const prizeLabel = document.getElementById("prizeLabel");
  const prizeCode  = document.getElementById("prizeCode");
  const hintText   = document.getElementById("hintText");

  // ============================
  // Scratch canvas (robust for iPad)
  // ============================
  const canvas = document.getElementById("scratch");
  const stage = document.getElementById("stage");
  const ctx = canvas.getContext("2d");

  let isDown = false;
  let scratchEnabled = false;
  let revealed = false;

  // make scratch easier on iPad
  const SCRATCH_RADIUS = 34;       // bigger brush
  const REVEAL_AT = 0.18;          // 18% cleared (easy)
  const SAMPLE_STEP = 14;          // speed vs accuracy

  // current player/prize
  let currentLeadId = null;
  let currentPrize = null;

  function resizeCanvas(){
    const rect = stage.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    canvas.width  = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);

    // scale drawing coordinates so we can draw in "CSS pixels"
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // (re)draw cover if we are in scratch mode
    drawCover();
  }

  function drawCover(){
    // Draw a solid gray scratch layer that ALWAYS exists when scratch is enabled
    const w = stage.getBoundingClientRect().width;
    const h = stage.getBoundingClientRect().height;

    // If not enabled, still show a cover so people can‚Äôt see anything / scratch
    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0,0,w,h);

    // gray card
    ctx.fillStyle = "#bfbfbf";
    ctx.fillRect(0,0,w,h);

    // subtle text
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.font = "bold 32px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SCRATCH HERE", w/2, h/2);

    // scratch mode
    ctx.globalCompositeOperation = "destination-out";
  }

  function pointerPos(evt){
    const rect = stage.getBoundingClientRect();
    const p = evt.touches ? evt.touches[0] : evt;
    return { x: p.clientX - rect.left, y: p.clientY - rect.top };
  }

  function scratchDot(x,y){
    ctx.beginPath();
    ctx.arc(x,y,SCRATCH_RADIUS,0,Math.PI*2);
    ctx.fill();
  }

  function percentCleared(){
    // sample pixels for speed
    const w = canvas.width;
    const h = canvas.height;

    const img = ctx.getImageData(0,0,w,h).data;
    let cleared = 0;
    let total = 0;

    // sample in device pixels (canvas is DPR-scaled)
    const step = Math.max(4, SAMPLE_STEP);
    for(let y=0; y<h; y+=step){
      for(let x=0; x<w; x+=step){
        const i = (y*w + x) * 4;
        const a = img[i+3];
        total++;
        if(a === 0) cleared++;
      }
    }
    return total ? (cleared/total) : 0;
  }

  function revealPrize(){
    if(revealed) return;
    revealed = true;

    // show prize text now
    prizeLabel.textContent = currentPrize?.label || "‚Äî";
    prizeCode.textContent  = "Code: " + (currentPrize?.code || "‚Äî");
    hintText.textContent   = "Show this code at checkout (or screenshot this screen).";

    // update lead record
    const leads = loadLeads();
    const idx = leads.findIndex(l => l.id === currentLeadId);
    if(idx !== -1){
      leads[idx].revealedAt = new Date().toISOString();
      leads[idx].prizeLabel = currentPrize?.label || "";
      leads[idx].prizeCode  = currentPrize?.code || "";
      saveLeads(leads);
    }

    // allow next student now
    nextBtn.disabled = false;
  }

  function checkComplete(){
    if(!scratchEnabled || revealed) return;
    const pct = percentCleared();
    if(pct >= REVEAL_AT) revealPrize();
  }

  function onDown(evt){
    if(!scratchEnabled) return;
    isDown = true;
    const p = pointerPos(evt);
    scratchDot(p.x,p.y);
    checkComplete();
    evt.preventDefault?.();
  }
  function onMove(evt){
    if(!scratchEnabled || !isDown) return;
    const p = pointerPos(evt);
    scratchDot(p.x,p.y);
    checkComplete();
    evt.preventDefault?.();
  }
  function onUp(){
    isDown = false;
  }

  canvas.addEventListener("mousedown", onDown);
  canvas.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);

  canvas.addEventListener("touchstart", onDown, {passive:false});
  canvas.addEventListener("touchmove", onMove, {passive:false});
  canvas.addEventListener("touchend", onUp, {passive:true});

  // ============================
  // Flow actions
  // ============================
  function setInventoryUI(){
    const inv = ensureInventory();
    invCount.textContent = inventoryRemaining(inv);
  }

  function lockInputs(locked){
    nameEl.disabled = locked;
    emailEl.disabled = locked;
  }

  function resetPrizeUI(){
    // keep prize hidden until scratch completion
    prizeLabel.textContent = "‚Äî";
    prizeCode.textContent  = "Code: ‚Äî";
    hintText.textContent   = "Scratch the gray card to reveal your discount.";
  }

  function startRound(){
    // called after Save
    revealed = false;
    scratchEnabled = true;

    resetPrizeUI();
    resizeCanvas(); // ensures gray cover is drawn at correct size

    // NOTE: prize already chosen and stored in currentPrize, but not shown yet
  }

  saveBtn.addEventListener("click", () => {
    const name = (nameEl.value || "").trim();
    const email = (emailEl.value || "").trim();

    if(!name){ alert("Please enter a full name."); return; }
    if(!validEmail(email)){ alert("Please enter a valid email."); return; }

    const inv = ensureInventory();
    const remaining = inventoryRemaining(inv);
    if(remaining <= 0){
      alert("Inventory is empty on this device.");
      return;
    }

    // choose prize now (inventory decremented now)
    const prize = pickPrize(inv);
    setInventoryUI();

    const id = uid();
    const leads = loadLeads();
    leads.unshift({
      id,
      name,
      email,
      savedAt: new Date().toISOString(),
      revealedAt: "",
      prizeLabel: "", // filled when revealed
      prizeCode: ""   // filled when revealed
    });
    saveLeads(leads);

    currentLeadId = id;
    currentPrize = prize;

    // UI
    savedBox.style.display = "block";
    savedText.textContent = `${name} ‚Äî ${email} (saved). Now scratch below to reveal your prize.`;

    lockInputs(true);
    saveBtn.disabled = true;
    saveBtn.textContent = "Saved ‚Äî scratch below!";

    nextBtn.disabled = true; // becomes enabled once prize is revealed
    startRound();
  });

  nextBtn.addEventListener("click", () => {
    // reset for next person
    nameEl.value = "";
    emailEl.value = "";

    lockInputs(false);
    saveBtn.disabled = false;
    saveBtn.textContent = "Save ‚Äî scratch below!";

    savedBox.style.display = "none";

    scratchEnabled = false;
    revealed = false;
    currentLeadId = null;
    currentPrize = null;

    resetPrizeUI();
    resizeCanvas(); // redraw cover
    nextBtn.disabled = true;
  });

  exportBtn.addEventListener("click", () => {
    const leads = loadLeads();
    if(!leads.length){
      alert("No leads yet.");
      return;
    }

    const header = "name,email,savedAt,revealedAt,prizeLabel,prizeCode\n";
    const rows = leads.map(l => {
      const esc = (s) => `"${String(s||"").replaceAll('"','""')}"`;
      return [
        esc(l.name),
        esc(l.email),
        esc(l.savedAt),
        esc(l.revealedAt),
        esc(l.prizeLabel),
        esc(l.prizeCode)
      ].join(",");
    }).join("\n");

    const blob = new Blob([header + rows], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "odgo_scratcher_leads.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  resetBtn.addEventListener("click", () => {
    if(!confirm("Reset ALL leads + inventory on this device?")) return;
    localStorage.removeItem(LEADS_KEY);
    localStorage.removeItem(INV_KEY);

    // reset UI to fresh state
    nameEl.value = "";
    emailEl.value = "";
    lockInputs(false);

    saveBtn.disabled = false;
    saveBtn.textContent = "Save ‚Äî scratch below!";
    nextBtn.disabled = true;

    savedBox.style.display = "none";

    scratchEnabled = false;
    revealed = false;
    currentLeadId = null;
    currentPrize = null;

    ensureInventory();
    setInventoryUI();

    resetPrizeUI();
    resizeCanvas();

    alert("Device data reset.");
  });

  // ============================
  // Init
  // ============================
  ensureInventory();
  setInventoryUI();
  resetPrizeUI();

  // draw cover immediately so the gray box ALWAYS appears
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);
})();
</script>
</body>
</html>

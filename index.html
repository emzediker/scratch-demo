<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OD on the GO ‚Äî Conference Scratcher</title>
<style>
  :root{
    --bg:#fafafa;
    --card:#ffffff;
    --text:#111;
    --muted:#666;
    --line:#e9e9e9;
    --btn:#111;
    --btnText:#fff;
    --soft:#f4f6ff;
  }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width:1100px; margin:28px auto; padding:0 14px; text-align:center; }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:18px;
    padding:20px;
    box-shadow:0 2px 14px rgba(0,0,0,.06);
  }
  h1{ margin:0 0 6px; font-size:32px; }
  .sub{ margin:0 0 18px; color:var(--muted); }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    max-width:760px;
    margin:0 auto;
    text-align:left;
  }
  .field label{ display:block; font-weight:900; font-size:13px; margin:0 0 6px; }
  .field input{
    width:100%;
    box-sizing:border-box;
    padding:12px 12px;
    border:1px solid #ddd;
    border-radius:12px;
    font-size:16px;
    outline:none;
  }
  .field input:disabled{ background:#f6f6f6; }

  .btnRow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    margin:14px 0 0;
  }
  button{
    border:0;
    border-radius:12px;
    padding:12px 16px;
    font-weight:900;
    font-size:15px;
    cursor:pointer;
  }
  .primary{ background:var(--btn); color:var(--btnText); min-width:220px; }
  .ghost{ background:#fff; color:#111; border:1px solid #ddd; }
  button:disabled{ opacity:.5; cursor:not-allowed; }

  .savedBox{
    max-width:760px;
    margin:14px auto 0;
    background:var(--soft);
    border:1px solid #cfe0ff;
    border-radius:14px;
    padding:12px 14px;
    text-align:left;
    display:none;
  }
  .savedBox .title{ font-weight:900; margin-bottom:6px; }
  .savedBox .line{ font-size:14px; color:#222; }

  .scratchWrap{
    max-width:860px;
    margin:18px auto 0;
    border:1px solid var(--line);
    border-radius:18px;
    padding:16px;
  }
  .scratchTop{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    color:var(--muted);
    font-size:13px;
    margin-bottom:10px;
  }

  .stage{
    position:relative;
    width:min(860px, 100%);
    height:320px;           /* <-- adjust taller/shorter here */
    margin:0 auto;
    border-radius:16px;
    overflow:hidden;
    border:1px solid #ddd;
    background:#f6f6f6;
  }

  .under{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    text-align:center;
    padding:16px;
    z-index:0;
  }
  .under .small{ color:#666; font-size:13px; margin-top:8px; }
  .under .big{
    font-size:34px;
    font-weight:900;
    margin-top:8px;
  }
  .under .code{
    margin-top:8px;
    font-size:14px;
    color:#333;
  }

  canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    z-index:1;
    touch-action:none;
  }

  .footerNote{
    max-width:860px;
    margin:10px auto 0;
    color:#777;
    font-size:12px;
    text-align:center;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>üéâ Scratch to Win</h1>
    <div class="sub">Enter name + email ‚Üí scratch to reveal your prize. (Offline demo: saved on this device, CSV export.)</div>

    <div class="grid">
      <div class="field">
        <label>Full Name</label>
        <input id="name" type="text" placeholder="Full name" autocomplete="name">
      </div>
      <div class="field">
        <label>Email Address</label>
        <input id="email" type="email" placeholder="name@email.com" autocomplete="email">
      </div>
    </div>

    <div class="btnRow">
      <button id="saveBtn" class="primary" type="button">Save &amp; Start Scratch</button>
      <button id="nextBtn" class="ghost" type="button" disabled>Next Student</button>
      <button id="exportBtn" class="primary" type="button" style="min-width:180px;">Export CSV</button>
      <button id="resetBtn" class="ghost" type="button">Reset Device Data</button>
    </div>

    <div id="savedBox" class="savedBox">
      <div class="title">Saved ‚úÖ</div>
      <div class="line" id="savedLine">‚Äî</div>
      <div class="line" style="margin-top:6px; color:#555;">Now scratch below to reveal your prize.</div>
    </div>

    <div class="scratchWrap">
      <div class="scratchTop">Scratch to reveal your prize</div>

      <div class="stage" id="stage">
        <div class="under">
          <div style="font-weight:900; color:#444;">üéÅ YOUR PRIZE</div>
          <div class="big" id="prizeLabel">Scratch to reveal‚Ä¶</div>
          <div class="code" id="prizeCode">Code: ‚Äî</div>
          <div class="small">Scratch the gray layer to reveal your discount.</div>
        </div>
        <canvas id="scratch"></canvas>
      </div>

      <div class="footerNote">
        Tip: each device has its own saved list + prize inventory (until we connect a backend).
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  // =========================
  // STORAGE KEYS
  // =========================
  const LEADS_KEY = "odgo_leads_v2";
  const INVENTORY_KEY = "odgo_inventory_v2";

  // =========================
  // PRIZE INVENTORY (CONTROLLED)
  // Edit codes later; labels can stay.
  // =========================
  function defaultInventory(){
    const inv = [];

    // 6 grand prizes with unique codes (placeholders ‚Äî you‚Äôll replace)
    inv.push({type:"FREE_PART1", label:"FREE Part 1 Course", code:"FREE-P1-001"});
    inv.push({type:"FREE_PART1", label:"FREE Part 1 Course", code:"FREE-P1-002"});
    inv.push({type:"FREE_PART2", label:"FREE Part 2 Course", code:"FREE-P2-001"});
    inv.push({type:"FREE_PART2", label:"FREE Part 2 Course", code:"FREE-P2-002"});
    inv.push({type:"FREE_PART3", label:"FREE Part 3 Course", code:"FREE-P3-001"});
    inv.push({type:"FREE_PART3", label:"FREE Part 3 Course", code:"FREE-P3-002"});

    // 50 x $50 off (same code allowed)
    for(let i=0;i<50;i++){
      inv.push({type:"50_OFF", label:"$50 OFF any course", code:"ODGO50"});
    }

    // 500 x 20% off (same code allowed)
    for(let i=0;i<500;i++){
      inv.push({type:"20_OFF", label:"20% OFF any course", code:"ODGO20"});
    }

    return inv;
  }

  function loadInventory(){
    try{
      const raw = localStorage.getItem(INVENTORY_KEY);
      if(!raw){
        const fresh = defaultInventory();
        localStorage.setItem(INVENTORY_KEY, JSON.stringify(fresh));
        return fresh;
      }
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed) || parsed.length === 0){
        const fresh = defaultInventory();
        localStorage.setItem(INVENTORY_KEY, JSON.stringify(fresh));
        return fresh;
      }
      return parsed;
    }catch{
      const fresh = defaultInventory();
      localStorage.setItem(INVENTORY_KEY, JSON.stringify(fresh));
      return fresh;
    }
  }

  function saveInventory(inv){
    localStorage.setItem(INVENTORY_KEY, JSON.stringify(inv));
  }

  // pick one prize from inventory, remove it (so counts are exact)
  function drawPrize(){
    const inv = loadInventory();
    if(inv.length === 0){
      // fallback if exhausted
      return {type:"20_OFF", label:"20% OFF any course", code:"ODGO20"};
    }
    const idx = Math.floor(Math.random() * inv.length);
    const prize = inv.splice(idx, 1)[0];
    saveInventory(inv);
    return prize;
  }

  // =========================
  // LEADS
  // =========================
  function loadLeads(){
    try{ return JSON.parse(localStorage.getItem(LEADS_KEY) || "[]"); }
    catch{ return []; }
  }
  function saveLeads(arr){
    localStorage.setItem(LEADS_KEY, JSON.stringify(arr));
  }
  function validEmail(s){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||"").trim());
  }
  function uid(){
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2));
  }

  // =========================
  // DOM
  // =========================
  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");
  const saveBtn = document.getElementById("saveBtn");
  const nextBtn = document.getElementById("nextBtn");
  const exportBtn = document.getElementById("exportBtn");
  const resetBtn = document.getElementById("resetBtn");
  const savedBox = document.getElementById("savedBox");
  const savedLine = document.getElementById("savedLine");

  const canvas = document.getElementById("scratch");
  const stage = document.getElementById("stage");
  const prizeLabelEl = document.getElementById("prizeLabel");
  const prizeCodeEl = document.getElementById("prizeCode");

  // =========================
  // SCRATCH ENGINE (iOS-safe)
  // =========================
  const ctx = canvas.getContext("2d", { willReadFrequently:true });

  let scratchEnabled = false;
  let isDown = false;
  let revealed = false;
  let currentLeadId = null;
  let currentPrize = null;
  let lastCheck = 0;

  function resizeCanvas(){
    const rect = stage.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw in CSS pixels
    drawCover();
  }

  function drawCover(){
    // Draw a solid cover layer (scratched away via destination-out)
    const rect = stage.getBoundingClientRect();
    const W = rect.width;
    const H = rect.height;

    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0,0,W,H);

    ctx.fillStyle = "#bfbfbf";
    ctx.fillRect(0,0,W,H);

    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.font = "900 28px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SCRATCH HERE", W/2, H/2);

    ctx.globalCompositeOperation = "destination-out";
  }

  function getPos(evt){
    const rect = stage.getBoundingClientRect();
    const p = evt.touches ? evt.touches[0] : evt;
    return { x: p.clientX - rect.left, y: p.clientY - rect.top };
  }

  function scratchDot(x,y){
    ctx.beginPath();
    ctx.arc(x,y,26,0,Math.PI*2);
    ctx.fill();
  }

  function percentCleared(){
    // sample pixels (downsample) so it's fast even on iPad
    const rect = stage.getBoundingClientRect();
    const W = Math.floor(rect.width);
    const H = Math.floor(rect.height);

    // read image at CSS size
    const img = ctx.getImageData(0, 0, W, H).data;
    let cleared = 0;
    const step = 8; // speed/accuracy tradeoff
    for(let y=0; y<H; y+=step){
      for(let x=0; x<W; x+=step){
        const i = (y*W + x) * 4 + 3; // alpha
        if(img[i] === 0) cleared++;
      }
    }
    const total = Math.ceil(H/step) * Math.ceil(W/step);
    return cleared / total;
  }

  function revealPrize(){
    if(revealed) return;
    revealed = true;

    // Now show the real prize text
    prizeLabelEl.textContent = currentPrize.label;
    prizeCodeEl.textContent = "Code: " + currentPrize.code;

    // update lead record with prize (it was already chosen at save-time)
    const leads = loadLeads();
    const idx = leads.findIndex(l => l.id === currentLeadId);
    if(idx >= 0){
      leads[idx].revealedAt = new Date().toISOString();
      leads[idx].prizeLabel = currentPrize.label;
      leads[idx].prizeCode = currentPrize.code;
      saveLeads(leads);
    }

    // enable Next Student
    nextBtn.disabled = false;
  }

  function checkRevealThrottled(){
    const now = Date.now();
    if(now - lastCheck < 250) return;
    lastCheck = now;
    const pct = percentCleared();
    if(pct >= 0.45){ // adjust threshold here (0.35 easier, 0.55 harder)
      revealPrize();
    }
  }

  function onDown(evt){
    if(!scratchEnabled) return;
    isDown = true;
    const p = getPos(evt);
    scratchDot(p.x, p.y);
    checkRevealThrottled();
    evt.preventDefault?.();
  }
  function onMove(evt){
    if(!scratchEnabled || !isDown) return;
    const p = getPos(evt);
    scratchDot(p.x, p.y);
    checkRevealThrottled();
    evt.preventDefault?.();
  }
  function onUp(){
    isDown = false;
  }

  canvas.addEventListener("mousedown", onDown);
  canvas.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);

  canvas.addEventListener("touchstart", onDown, { passive:false });
  canvas.addEventListener("touchmove", onMove, { passive:false });
  canvas.addEventListener("touchend", onUp);

  window.addEventListener("resize", resizeCanvas);

  // =========================
  // FLOW: SAVE -> SCRATCH -> REVEAL -> NEXT
  // =========================
  function lockForm(locked){
    nameEl.disabled = locked;
    emailEl.disabled = locked;
    saveBtn.disabled = locked;
  }

  function setHiddenPrizeUI(){
    prizeLabelEl.textContent = "Scratch to reveal‚Ä¶";
    prizeCodeEl.textContent = "Code: ‚Äî";
  }

  function startRoundForLead(leadId, prize){
    currentLeadId = leadId;
    currentPrize = prize;
    revealed = false;
    scratchEnabled = true;
    setHiddenPrizeUI();
    drawCover();
  }

  saveBtn.addEventListener("click", () => {
    const name = (nameEl.value || "").trim();
    const email = (emailEl.value || "").trim();

    if(!name){ alert("Please enter full name."); return; }
    if(!validEmail(email)){ alert("Please enter a valid email."); return; }

    // choose prize NOW but keep hidden until scratch completion
    const prize = drawPrize();

    const lead = {
      id: uid(),
      name,
      email,
      savedAt: new Date().toISOString(),
      revealedAt: null,
      prizeLabel: null,
      prizeCode: null,
      assignedPrizeLabel: prize.label,
      assignedPrizeCode: prize.code
    };

    const leads = loadLeads();
    leads.unshift(lead);
    saveLeads(leads);

    savedLine.textContent = `${lead.name} ‚Äî ${lead.email} (saved). Now scratch below to reveal your prize.`;
    savedBox.style.display = "block";

    lockForm(true);
    saveBtn.textContent = "Saved ‚Äî scratch below!";
    nextBtn.disabled = true;

    startRoundForLead(lead.id, prize);
  });

  nextBtn.addEventListener("click", () => {
    // reset UI for next person
    nameEl.value = "";
    emailEl.value = "";
    savedBox.style.display = "none";

    lockForm(false);
    saveBtn.textContent = "Save & Start Scratch";

    // reset scratch state
    scratchEnabled = false;
    currentLeadId = null;
    currentPrize = null;
    revealed = false;
    nextBtn.disabled = true;

    setHiddenPrizeUI();
    drawCover();
  });

  exportBtn.addEventListener("click", () => {
    const leads = loadLeads();
    if(!leads.length){
      alert("No leads yet.");
      return;
    }

    const header = "name,email,savedAt,revealedAt,assignedPrizeLabel,assignedPrizeCode,revealedPrizeLabel,revealedPrizeCode\n";
    const rows = leads.map(l => {
      const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
      return [
        esc(l.name),
        esc(l.email),
        esc(l.savedAt),
        esc(l.revealedAt || ""),
        esc(l.assignedPrizeLabel || ""),
        esc(l.assignedPrizeCode || ""),
        esc(l.prizeLabel || ""),
        esc(l.prizeCode || "")
      ].join(",");
    }).join("\n");

    const blob = new Blob([header + rows], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "odgo_conference_leads.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  resetBtn.addEventListener("click", () => {
    if(!confirm("Reset ALL saved leads + inventory on this device?")) return;
    localStorage.removeItem(LEADS_KEY);
    localStorage.removeItem(INVENTORY_KEY);
    alert("Device data reset.");
    location.reload();
  });

  // init
  setHiddenPrizeUI();
  resizeCanvas();           // ensures canvas size matches iPad display
  drawCover();
})();
</script>

</body>
</html>
